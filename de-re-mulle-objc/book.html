<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<!-- seems to be needed -->

<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">

<title>De Re mulle-objc</title>

<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="De Re mulle-objc">

<meta name="twitter:site" content="@mulle_nat">
<meta name="twitter:creator" content="@mulle_nat">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.mulle-kybernetik.com/de-re-mulle-objc/images/features/book.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="De Re mulle-objc">

<meta property="og:url" content="https://www.mulle-kybernetik.com/book.html">
<meta property="og:site_name" content="De Re mulle-objc">

<meta property="og:image" content="https://www.mulle-kybernetik.com/de-re-mulle-objc/images/features/book.png">

<meta property="og:logo" content="https://www.mulle-kybernetik.com/de-re-mulle-objc/images/logo.png">



<link href="/de-re-mulle-objc/atom.xml" type="application/atom+xml" rel="alternate" title="De Re mulle-objc Feed">
<link href="/de-re-mulle-objc/index.rdf" type="application/rss+xml" rel="alternate" title="De Re mulle-objc Feed">


<link rel="canonical" href="https://www.mulle-kybernetik.com/book.html">


<!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta name="viewport" content="width=device-width, initial-scale=1">


<!-- CSS
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="css/skeleton.css">

<!-- Code Color
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="stylesheet" href="css/monokai.css">

<!-- Site custom css -->
<link rel="stylesheet" href="css/custom.css">

<!-- local FONT
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="stylesheet" href="css/junction.css">
<link rel="stylesheet" href="css/poppins.css">

<!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="icon" type="image/svg" href="images/favicon.svg">

<!-- This tag allows for activation of ClearType in Mobile IE for smoothing fonts.-->
<meta http-equiv="cleartype" content="on">
<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->


</head>
<body class="post">


<div class="container">
   <div class="row">
      <div id="post-first" class="twelve columns">
         <div class="title">
            <div>
               <h2>De Re mulle-objc&nbsp;<div style="font-size:10px; display: inline-block;">0.50.0</div>&nbsp;&nbsp;<a href="feed.xml"><img class="inline-img" src='images/feed-icon-28x28.png'></a></h2>
            </div>
            <h6>© 2025 by Nat!, Mulle kybernetiK. All rights reserved.</h6>
            <p>
         </div> <!-- title -->

         <div id="main" role="main">
         
             <h1>De Re mulle-objc</h1>
             <p><img src="images/dere.jpg" alt="Logo" /></p>

<p>Welcome to the developer guide for <a href="//mulle-objc.github.io">mulle-objc</a>. This
guide will enable you to get up and running quickly with Objective-C on the
platform of your choice.</p>

<h2 id="system-requirements">System Requirements</h2>

<p>mulle-objc is C, so anywhere C runs Objective-C should run too. But that’s
not entirely true. mulle-objc is not suitable for tiny CPUs. When you
build the Foundation library as a shared library you end up with 2.5MB
(mulle-objc 0.5MB). So any system with less than 4MB RAM, will likely not
cut it. The CPU needs to be at least 32 bit wide to be able to
use mulle-objc selectors efficiently.</p>

<p>You can expect the MulleObjC library to work on any suitable ARM or X86_64 or I686 system. The Foundation support outside of Linux, FreeBSD and macOS is still somewhat iffy.</p>

<h2 id="license">License</h2>

<p>mulle-objc is permissively - BSD3 - licensed and free of cost, meaning
you can use it anywhere you like and wish.</p>

<h2 id="objective-c-tutorials">Objective-C Tutorials</h2>

<p>A complete Objective-C tutorial is outside the scope of this manual, but
there some useful ones online, in case you are not familiar with the
language. Most of these cover Objective-C in its 2.0 (Apple) incarnation. Consult <a href="differences.html">Differences to Objective-C 2.0</a> if you are in doubt about the applicability of what’s written to mulle-objc.</p>

<p>In general ignore parts about “gcc”, “Xcode”, “MacOSX”, “GNUStep”. Ignore parts about “Dot Syntax” as well as “Blocks” and anything mentioning “ARC”.</p>

<table>
  <thead>
    <tr>
      <th>Resource</th>
      <th>Publisher</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://fullonrager.github.io/rys-objective-c-tutorial-archive/introduction.html">Ry’s Objective-C Tutorial</a></td>
      <td>RyPress</td>
      <td>Very easy to read. Just keep in mind, that mulle-objc prefers <code class="language-plaintext highlighter-rouge">+object</code> over <code class="language-plaintext highlighter-rouge">+alloc</code>/<code class="language-plaintext highlighter-rouge">-init</code> and prefers <code class="language-plaintext highlighter-rouge">mulle_printf</code> over <code class="language-plaintext highlighter-rouge">NSLog</code></td>
    </tr>
    <tr>
      <td><a href="https://www.tutorialspoint.com/objective_c/objective_c_quick_guide.htm">Learn Objective-C Quick Guide</a></td>
      <td>Tutorialspoint</td>
      <td>Looks like a good tutorial.</td>
    </tr>
    <tr>
      <td><a href="https://codescracker.com/objective-c/index.htm">Objective-C Tutorial</a></td>
      <td>Codecrackers</td>
      <td>This is basically the same as whats offered at Tutorialspoint, but there are differences. Someone plagiarized but I can’t tell who did it. The codecrackers page looks a bit nicer</td>
    </tr>
    <tr>
      <td><a href="https://etutorials.org/Programming/Cocoa/Part+I+Introducing+Cocoa/Chapter+1.+Objective-C/">Objective-C Tutorial</a></td>
      <td>Etutorials</td>
      <td>???</td>
    </tr>
    <tr>
      <td><a href="https://www.cocoadevcentral.com/d/learn_objectivec">Learn Objective-C</a></td>
      <td>CocoaDev</td>
      <td>Gives a quick overview of concepts.</td>
    </tr>
    <tr>
      <td><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Introduction/Introduction.html">Programming With Objective C</a></td>
      <td>Apple</td>
      <td>This covers all the basics.</td>
    </tr>
  </tbody>
</table>

<h2 id="mulle-objc-reads">mulle-objc Reads</h2>

<p>Once you got the hang on Objective-C, the following list of mulle-objc
pamphlets will surely be of interest:</p>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://mulle-objc.github.io/De-Re-mulle-objc/index.html#mulle-objc-portal">De Re mulle-objc</a></td>
      <td>A hands on intro to develop mulle-objc programs combined with some deeper technical insights.</td>
    </tr>
    <tr>
      <td><a href="https://www.mulle-kybernetik.com/de-re-nsobject">De Re NSObject</a></td>
      <td>All about NSObject, object management, @autoreleasepool and coding conventions. A must read.</td>
    </tr>
    <tr>
      <td><a href="https://www.mulle-kybernetik.com/de-re-property/">De Re @property</a></td>
      <td>All about @property and its attributes. Required reading for all mulle-objc developers.</td>
    </tr>
    <tr>
      <td><a href="https://www.mulle-kybernetik.com/objc-runtime-in-pictures/">Objective-C Runtime in Pictures</a></td>
      <td>The bits and bytes perspective on the mulle-objc runtime</td>
    </tr>
    <tr>
      <td><a href="https://www.mulle-kybernetik.com/mulle-objc-ide/">mulle-objc Development with IDEs</a></td>
      <td>How to setup several popular IDEs for mulle-objc development.</td>
    </tr>
    <tr>
      <td><a href="https://www.mulle-kybernetik.com/de-re-mulle-sde/">De Re mulle-sde</a></td>
      <td>Developer guide for mulle-sde, should cover most workflow topics</td>
    </tr>
    <tr>
      <td><a href="https://github.com/mulle-objc/Objective-C-CheatSheet">mulle-objc CheatSheet</a></td>
      <td>The is a good way to get a quick overview of what the Mulle Objective-C dialect has to offer. It is tailored to mulle-objc specifically, but it is no tutorial.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/mulle-sde/mulle-sde/wiki">Mulle-sde WiKi</a></td>
      <td>Mulle-sde WIKI more indepth information about the tooling.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/mulle-objc/mulle-objc.github.io/issues/1">mulle-objc community membership</a></td>
      <td>It’s free!</td>
    </tr>
  </tbody>
</table>

<h2 id="other-objective-c-reads">Other Objective-C Reads</h2>

<p>Most of these books cover Objective-C in its 2.0 incarnation. Consult
<a href="differences.html">Differences to Objective-C 2.0</a>,
if you are in doubt about the applicability of what’s written:</p>

<table>
  <thead>
    <tr>
      <th>Resource</th>
      <th>Publisher</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Introduction/Introduction.html">Concepts in Objective-C Programming</a></td>
      <td>Apple</td>
      <td>This is a more in-depth read to understand some terminology used by fellow Objective-C coders. Ignore the chapters “Delegates and Data Sources”, “Model View Controller”, “Object Modeling”, “Outlets”, “Receptionist Pattern”, “Target-Action”, “Toll-Free Bridging”</td>
    </tr>
    <tr>
      <td><a href="https://nshipster.com/">NSHipster</a></td>
      <td>Mattt</td>
      <td>Some articles cover Objective-C and the Foundation</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://www.onlineprogrammingbooks.com/objective-c/">onlineprogrammingbooks</a></td>
      <td>A list of downloadable book PDFs.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/objc-zen/objc-zen-book">Zen and the Art of the Objective-C Craftsmanship</a></td>
      <td>Bernardi - De Bortoli</td>
      <td>A more advanced read. On a cursory examination, there is a lot there, that’s not applicable to mulle-objc or that goes against the mulle-objc style.</td>
    </tr>
  </tbody>
</table>

<h2 id="mulle-objc-portal">mulle-objc Portal</h2>

<p>Periodically check out <a href="https://mulle-objc.github.io">mulle-objc</a> which is the portal
for all things mulle-objc.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Project Setup</h1>
             <h2 id="install-mulle-objc">Install mulle-objc</h2>

<p>This guide doesn’t have detailed installation instructions for
<strong>mulle-objc</strong>.</p>

<p>Read the instructions on
<a href="https://github.com/MulleFoundation/foundation-developer">foundation-developer</a>
and follow them.</p>

<p>Afterwards you should have <strong>mulle-clang</strong> and <strong>mulle-sde</strong> in your PATH.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-clang --version
mulle-sde --version
</span></code></pre></div></div>

<p>and you should all be setup for coding.</p>

<h2 id="foundation-vs-mulle-objc">Foundation vs mulle-objc</h2>

<p>There are two starting points. If you want a full class system with strings,
containers and OS support, you will want to base your code on the <strong>Foundation</strong>.</p>

<p>If you just want to play with a minimal runtime, base your code on <strong>MulleObjC</strong>. This is the best choice for new platforms.
Then, instead of <code class="language-plaintext highlighter-rouge">-m foundation/objc-developer</code>, use <code class="language-plaintext highlighter-rouge">-m mulle-objc/objc-developer</code></p>

<p>mulle-sde is powerful enough to warrant its own guide <a href="//www.mulle-kybernetik.com/de-re-mulle-sde/">De Re mulle-sde</a>. But to get you moving quickly,
lets set up a demo project right now:</p>

<h2 id="example-hello-world-project">Example “Hello World” project</h2>

<h3 id="create">Create</h3>

<p>Generate a new executable project with:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde init -m foundation/objc-developer -d hello-world executable
</span></code></pre></div></div>

<p>Your project filesystem structure on your file system will look like the
following <code class="language-plaintext highlighter-rouge">tree</code> output. You can see the demo source in <code class="language-plaintext highlighter-rouge">src/main.m</code> along
with more generated content:</p>

<pre><font color="#3465A4"><b>hello-world</b></font>
├── <font color="#3465A4"><b><i>.mulle</i></b></font>
├── CMakeLists.txt
├── README.md
├── <font color="#3465A4"><b>cmake</b></font>
│   ├── <font color="#3465A4"><b>reflect</b></font>
│   │   ├── _Dependencies.cmake
│   │   ├── _Headers.cmake
│   │   ├── _Libraries.cmake
│   │   ├── README.md
│   │   └── _Sources.cmake
│   └── <font color="#3465A4"><b>share</b></font>
│       ├── AAMSupportObjC.cmake
│       ├── ...
│       └── UnwantedWarningsC.cmake
└── <font color="#3465A4"><b>src</b></font>
    ├── import.h
    ├── import-private.h
    ├── main.m
    ├── <font color="#3465A4"><b><i>reflect</i></b></font>
    │   ├── <i>_hello-world-import.h</i>
    │   ├── <i>_hello-world-import-private.h</i>
    │   └── <i>objc-loader.inc</i>
    └── version.h
</pre>

<p><code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> is your main <a href="//cmake.org">cmake</a> project file. <a href="//cmake.org">cmake</a> is
the default mulle-sde build system, but it can be substituted with another,
if so desired.</p>

<p>The source is in the <code class="language-plaintext highlighter-rouge">src</code> folder. Source will be found in <code class="language-plaintext highlighter-rouge">src</code> or in any of the
its subfolders. A source file anywhere else will not be picked up by
<code class="language-plaintext highlighter-rouge">mulle-sde reflect</code> and will therefore not be built. (You can change the
default behaviour later)</p>

<h4 id="special-folders">Special folders</h4>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">.mulle</code> folder is used for project management. You usually edit its
contents via mulle-sde commands and not directly.</li>
  <li><code class="language-plaintext highlighter-rouge">reflect</code> folders will be recreated whenever the <code class="language-plaintext highlighter-rouge">mulle-sde reflect</code>
command is run, so don’t edit them.</li>
  <li><code class="language-plaintext highlighter-rouge">share</code> folders will be overwritten when the <code class="language-plaintext highlighter-rouge">mulle-sde upgrade</code>
command is run, so don’t edit those either.</li>
  <li><code class="language-plaintext highlighter-rouge">var</code> folders (found inside <code class="language-plaintext highlighter-rouge">.mulle</code>) can change any time a mulle-sde command is run, so don’t
touch them.</li>
</ul>

<h3 id="run">Run</h3>

<p>You are ready to craft your executable and run it. The very first <code class="language-plaintext highlighter-rouge">craft</code>
command will be quite slow, as mulle-sde will setup a virtual environment
for your project. This is somewhat akin to creating a <em>docker</em> container. 
mulle-sde needs to do it once:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">cd hello-world
mulle-sde craft
mulle-sde run
</span></code></pre></div></div>

<h3 id="edit">Edit</h3>

<p>Consult the <a href="https://www.mulle-kybernetik.com/mulle-objc-ide/">mulle-objc Development with IDEs</a>
guide to set up an editor or IDE of your preference.</p>

<p>You can then edit your project with:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mulle</span><span class="k">-</span><span class="n">sde</span> <span class="n">edit</span>
</code></pre></div></div>

<h3 id="add">Add</h3>

<p>Source files live in the <code class="language-plaintext highlighter-rouge">src</code> folder of your project.</p>

<p>The most convenient way to add files is with the <code class="language-plaintext highlighter-rouge">mulle-sde add</code> command, as
this gives you preconfigured implementation and interface files for a new class
for instance.
If you use a <code class="language-plaintext highlighter-rouge">+</code> in your filename, you will get files for a category.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde add src/Foo.m
mulle-sde add src/Foo+Stuff.m
</span></code></pre></div></div>

<p>The add command will automatically run <code class="language-plaintext highlighter-rouge">mulle-sde reflect</code>, so that is all
there is to it. You can now craft your project with <code class="language-plaintext highlighter-rouge">mulle-sde craft</code> again.</p>

<p>You can use the <code class="language-plaintext highlighter-rouge">-t</code> option to specify the exact type of Objective-C
construct you want to generate (e.g. <code class="language-plaintext highlighter-rouge">mulle-sde add -t protocolclass src/Boo.m</code>).
Out of the box, mulle-objc provides these three types:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">category</code></td>
      <td>Category <code class="language-plaintext highlighter-rouge">.m</code> and <code class="language-plaintext highlighter-rouge">.h</code> file</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">protocolclass</code></td>
      <td>Protocolclass <code class="language-plaintext highlighter-rouge">.m</code> and <code class="language-plaintext highlighter-rouge">.h</code> file</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">file</code></td>
      <td>Class <code class="language-plaintext highlighter-rouge">.m</code> and <code class="language-plaintext highlighter-rouge">.h</code> file</td>
    </tr>
  </tbody>
</table>

<h3 id="rename-and-remove">Rename and Remove</h3>

<p>You can move, rename or remove sources anyway you like with whatever
tool you like. After you made your
changes, run <code class="language-plaintext highlighter-rouge">mulle-sde reflect</code> to reflect your changes back into
<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> (indirectly via <code class="language-plaintext highlighter-rouge">cmake/_Headers.cmake</code> and
<code class="language-plaintext highlighter-rouge">cmake/_Sources.cmake</code>).</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mkdir -p src/foo/wherever
mv src/Foo.* src/foo/wherever
mulle-sde reflect
mulle-sde craft
</span></code></pre></div></div>

<p>You can check that your files are found with <code class="language-plaintext highlighter-rouge">mulle-sde files</code>. You can
see how the proper include paths are generated by looking at the
<code class="language-plaintext highlighter-rouge">INCLUDE_DIRS</code> variable in <code class="language-plaintext highlighter-rouge">cmake/reflect/_Headers.cmake</code>.</p>

<h3 id="settings">Settings</h3>

<p>You can look at the project settings with <code class="language-plaintext highlighter-rouge">mulle-sde env</code>.
You will see these relevant entries for source files:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">PROJECT_SOURCE_DIR="src"
MULLE_MATCH_FILENAMES="config:*.h:*.inc:*.c:CMakeLists.txt:*.cmake:*.m:*.aam"
MULLE_MATCH_IGNORE_PATH=
</span><span class="gp">MULLE_MATCH_PATH=".mulle/etc/sourcetree/config:$</span><span class="o">{</span>PROJECT_SOURCE_DIR<span class="o">}</span>:CMakeLists.txt:cmake<span class="s2">"
</span></code></pre></div></div>

<p>Files that match any of the wildcards given in <code class="language-plaintext highlighter-rouge">MULLE_MATCH_FILENAMES</code> are
considered interesting, <em>matchable</em> files. Changes in any of those files
should trigger a recraft. <code class="language-plaintext highlighter-rouge">MULLE_MATCH_PATH</code> contains the combination of files
and directories that will be searched. Conversely files, will be ignored that
are found in <code class="language-plaintext highlighter-rouge">MULLE_MATCH_PATH</code> but that are part of <code class="language-plaintext highlighter-rouge">MULLE_MATCH_IGNORE_PATH</code>.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Generic Headers</h1>
             <p>Ideally source files should be motile. One would like to easily move them
between various projects without having to edit anything. The modern workflow
achieves this with generic header names.</p>

<p>As we saw in the
previous chapter, headers and libraries are transparently added and removed
to a project with mulle-sde. All the <strong>external</strong> dependencies are isolated
in header files with generic names. Headers belonging to the project do not
appear in these files.</p>

<table>
  <thead>
    <tr>
      <th>Header</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">include.h</code></td>
      <td>Used by C header files</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">include-private.h</code></td>
      <td>Used by C source files</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">import.h</code></td>
      <td>Used by Objective-C interface files</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">import-private.h</code></td>
      <td>Used by Objective-C implementation files</td>
    </tr>
  </tbody>
</table>

<p>So we can write our source code in a uniform way.</p>

<h2 id="objective-c">Objective-C</h2>

<p><code class="language-plaintext highlighter-rouge">Foo.h</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "import.h"
</span>

<span class="k">@interface</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>and the implementation like so:</p>

<p><code class="language-plaintext highlighter-rouge">Foo.m</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "Foo.h"
</span>
<span class="cp">#import "import-private.h"
</span>
<span class="k">@implementation</span> <span class="nc">Foo</span>
<span class="k">@end</span>
</code></pre></div></div>

<h2 id="c">C</h2>

<p>For C its quite the same, but different header files are used.</p>

<p><code class="language-plaintext highlighter-rouge">foo.h</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"include.h"</span><span class="cp">
</span>

<span class="kt">void</span>  <span class="nf">foo</span><span class="p">(</span> <span class="kt">void</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">foo.c</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"foo.h"</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"include-private.h"</span><span class="cp">
</span>
<span class="kt">void</span>  <span class="nf">foo</span><span class="p">(</span> <span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">calling</span><span class="p">(</span> <span class="s">"whatever"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>As platform dependent headers and <code class="language-plaintext highlighter-rouge">#ifdef</code> definitions are isolated in
the generic headers, this is basically all there is to it. Read <a href="https://www.mulle-kybernetik.com/weblog/2019/beauty_of_generic_headers.html">The beauty of generic header-names</a>
for more details on this topic.</p>

<blockquote>
  <p>Memo: What doesn’t work yet, is full independence from other headers in the
same library.</p>
</blockquote>

             
             <div class="pagebreak"></div>
             
         
             <h1>Dependencies</h1>
             <p>Your mulle-objc project will have dependencies. One dependency is either the
MulleObjC library or the Foundation library and their constituent libraries.
But you will likely want to add more.</p>

<p>mulle-sde makes this easy and in the best case a one-liner. Here’s
how.</p>

<h2 id="mulle-sde-dependency-manages-the-sourcetree">mulle-sde dependency manages the sourcetree</h2>

<p>All dependencies are managed via a <em>sourcetree</em>. If you have created a
mulle-sde project as described previously, you can look at the pre-defined
sourcetree with <code class="language-plaintext highlighter-rouge">mulle-sde dependency list</code> or  <code class="language-plaintext highlighter-rouge">mulle-sourcetree list</code>
(use <code class="language-plaintext highlighter-rouge">-l -u</code> for more detail).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| address
|--------
| Foundation
| Foundation-startup
</code></pre></div></div>

<p>These dependencies again can be mulle-sde and non mulle-sde projects.
Each mulle-sde project in turn may have its own sourcetree with
dependencies. So you can see where this is heading…</p>

<h2 id="add-a-repository-from-github">Add a repository from github</h2>

<p>When adding a third-party repository, the first thing to decide is, if it is
a C or an Objective-C repository. At this point in time  C is more likely, so
we will go with that first.</p>

<p>For github repositories there is a special syntax available, so you don’t have
to type in the whole URL. This command adds
<a href="">https://github.com/libexpat/libexpat</a> to your project:</p>

<h3 id="c">C:</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde dependency add --c github:libexpat/libexpat
</span></code></pre></div></div>

<p>This command adds
<a href="">https://github.com/MulleWeb/MulleZlib</a> to your project:</p>

<h3 id="objective-c">Objective-C:</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde dependency add github:MulleWeb/MulleZlib
</span></code></pre></div></div>

<h2 id="get-build-commands-for-free">Get build commands for free</h2>

<p><strong>libexpat</strong> is special, in that there is a <strong>craftinfo</strong> available for it.
Many libraries can be built without a <strong>craftinfo</strong>, but for some libraries
like <strong>libexpat</strong> a few tweaks are desirable. The <strong>craftinfo</strong> contains these
tweaks.</p>

<p>You can look at the <a href="https://github.com/craftinfo">craftinfo</a> site to see
what is available.</p>

<blockquote>
  <p>If you have a craftinfo, that you would like to share, you are very welcome
to contribute this craftinfo.</p>
</blockquote>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> You can examine and manipulate craftinfos with the
<code class="language-plaintext highlighter-rouge">mulle-sde dependency craftinfo</code> command.</div>

<h2 id="header-and-link-commands-are-automatically-created">Header and link commands are automatically created</h2>

<p><code class="language-plaintext highlighter-rouge">mulle-sde reflect</code> will reflect the contents of the sourcetree into <strong>cmake</strong> files
residing under <code class="language-plaintext highlighter-rouge">./cmake</code> and into header files residing under <code class="language-plaintext highlighter-rouge">./src</code>.
This means you will not have to write any <code class="language-plaintext highlighter-rouge">#include</code> statements or add link
commands to your project. As dependencies are recursive, you also won’t have to
figure out against which system library to link.</p>

<h3 id="fix-a-missing-include">Fix a missing include</h3>

<p>Often mulle-sde can not guess the correct name and location of the central
include header of a dependency correctly. This can be rectified with:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde dependency set libexpat include "expat.h"
mulle-sde reflect
</span></code></pre></div></div>

<h3 id="fix-a-missing-library">Fix a missing library</h3>

<p>More rarely a library can not be found, because the name differs from the
project. Fix this with:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde dependency set libexpat aliases eXpat
mulle-sde reflect
</span></code></pre></div></div>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> There is a lot more information about
mulle-sde and various kinds of dependencies available in the
<a href="https://github.com/mulle-sde/mulle-sde/wiki">mulle-sde Wiki</a>.</div>

<h2 id="remove-dependency">Remove dependency</h2>

<p>Removing a dependency again is as easy as typing <code class="language-plaintext highlighter-rouge">mulle-sde dependency
remove libexpat</code> and letting <code class="language-plaintext highlighter-rouge">mulle-sde reflect</code> reflect the changes back into
cmake and header files.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Projects with Multiple Targets</h1>
             <p>Objective-C is an <a href="https://en.wikipedia.org/wiki/Object-oriented_programming">Object Oriented Programming Language</a>.
With that comes the expectation of a <a href="https://dl.acm.org/doi/10.1145/2601328.2601334">plug-n-play</a> programming environment.</p>

<p>It should be possible to add and remove functionality, without
breaking the application. This expectation has been historically never
fulfilled, due to deficiencies with the compilation tools, the Objective-C
runtime and the way headers are handled.</p>

<p>A golden rule of mulle-objc is: do not create projects
with multiple targets. Instead create multiple projects and link them
together via dependencies.</p>

<h2 id="setting-up-a-complex-project-for-the-modern-workflow">Setting up a complex project for the modern workflow</h2>

<p>If you have a library and an executable, make them two
separate projects.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde init -m foundation/objc-developer -d mylib library
mulle-sde init -m foundation/objc-developer -d myexe executable
</span></code></pre></div></div>

<p>Your project layout would then look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>myproject
├── myexe
└── mylib
</code></pre></div></div>

<p>As you want to use the library with your executable, you add the library as a
dependency to the executable:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">cd myexe
</span><span class="gp">mulle-sde dependency add --objc --github "$</span><span class="o">{</span>GITHUB_USERNAME:-nobody<span class="o">}</span><span class="s2">" mylib
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">GITHUB_USERNAME</code> can be fake, but it is needed to create a URL
for the library project, just in case you want to distribute your executable
later. It can also be changed later.</p>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> Since <code class="language-plaintext highlighter-rouge">mylib</code> is a sibling of <code class="language-plaintext highlighter-rouge">myexe</code> it
will be easily found. If you place it somewhere else, you need to add it’s
parent directory to the search-path variable <code class="language-plaintext highlighter-rouge">MULLE_FETCH_SEARCH_PATH</code>.
E.g. <code class="language-plaintext highlighter-rouge">mylib</code> is <code class="language-plaintext highlighter-rouge">/home/wherever/src/mylib</code> then modify the search-path with <code class="language-plaintext highlighter-rouge">mulle-sde environment set MULLE_FETCH_SEARCH_PATH '/home/wherever/src:${MULLE_FETCH_SEARCH_PATH}'</code></div>

<p>With <code class="language-plaintext highlighter-rouge">mulle-sde dependency list</code> or the more low-level <code class="language-plaintext highlighter-rouge">mulle-sourcetree list -ll</code>
you can see the dependency structure of your project.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>address             marks                                           aliases  include
-------             -----                                           -------  -------
Foundation          no-singlephase
Foundation-startup  no-dynamic-link,no-header,no-intermediate-link
mylib               no-singlephase
</code></pre></div></div>

<p>At this point you’re ready to craft again.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mulle-sde craft
</span></code></pre></div></div>

<p>And there you are.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> You do not have to <code class="language-plaintext highlighter-rouge">#import</code> anything or add link
statements to your <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>, it’s all done for you with
<code class="language-plaintext highlighter-rouge">mulle-sde reflect</code>.</div>


             
             <div class="pagebreak"></div>
             
         
             <h1>Good mulle-objc Code</h1>
             <h2 id="good-code">Good Code</h2>

<p>Objective-C is a fairly simple language extension. In this file all available
Objective-C keywords and concepts will be discussed. Absent will be library
features introduced by the Foundation.</p>

<p>The code will be regular Objective-C, unless specifically noted to be an
Objective-C extension.</p>

<h3 id="forward-declaration-and-import">Forward Declaration and Import</h3>

<p>You can <code class="language-plaintext highlighter-rouge">#import</code>  and forward declare code:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="c1">// forward declarations of a class and a protocol</span>
<span class="k">@protocol</span> <span class="nc">SomeProtocol</span><span class="p">;</span>
<span class="k">@class</span> <span class="nc">Foreign</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="protocol">Protocol</h3>

<p>You can declare a protocol with <strong>@optional</strong>  and <strong>@required</strong> methods and
properties:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// declare a protocol with a required (default)</span>
<span class="c1">// and an optional method</span>
<span class="k">@protocol</span> <span class="nc">MethodProtocol</span>

<span class="err">@required</span>
<span class="k">-</span> <span class="p">(</span><span class="n">Foreign</span> <span class="o">*</span><span class="p">)</span> <span class="n">someMethod</span><span class="p">;</span>

<span class="k">@optional</span>
<span class="k">-</span> <span class="p">(</span><span class="n">Foreign</span> <span class="o">*</span><span class="p">)</span> <span class="n">otherMethod</span><span class="p">;</span>

<span class="c1">// properties can be declared in protocols, yet the</span>
<span class="c1">// class must redeclare them</span>

<span class="k">@property</span><span class="p">(</span> <span class="n">assign</span><span class="p">)</span> <span class="n">NSUInteger</span>  <span class="n">value</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>You can extend forward declared classes with your protocol, but this is rarely
useful:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// extend Foreign class with this method, so</span>
<span class="c1">// we know we can message it with that protocol</span>
<span class="k">@class</span> <span class="nc">Foreign</span><span class="o">&lt;</span> <span class="n">MethodProtocol</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="classes">Classes</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma clang diagnostic ignored "-Wobjc-root-class"
</span><span class="k">@interface</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span> <span class="n">MethodProtocol</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">@public</span>        <span class="c1">// The usual visibility modifiers except `@package`</span>
<span class="k">@protected</span>
<span class="k">@private</span>
   <span class="n">NSUInteger</span>   <span class="n">_value</span><span class="p">;</span>    <span class="c1">// will be used as property "value" ivar</span>
<span class="p">}</span>

<span class="c1">// properties and all supported property attributes</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">readwrite</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">NSUInteger</span>  <span class="n">value</span><span class="p">;</span>      <span class="c1">// reimplement Protocol</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">retain</span><span class="p">)</span> <span class="n">Foreign</span>     <span class="o">*</span><span class="n">foreign</span><span class="p">;</span>   <span class="c1">// creates own ivar</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">nonnull</span><span class="p">)</span> <span class="n">NSString</span>    <span class="o">*</span><span class="n">backedByIvar</span><span class="p">;</span> <span class="c1">// creates own ivar</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>The implementation can <strong>@synthesize</strong> a property but it is superflous. The name
of the instance variable is fixed by the compiler to be <code class="language-plaintext highlighter-rouge">'_'&lt;name&gt;</code>.
<code class="language-plaintext highlighter-rouge">Foo</code> implements the required method from <code class="language-plaintext highlighter-rouge">MethodProtocol</code>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="k">@synthesize</span> <span class="n">foreign</span> <span class="o">=</span> <span class="n">_foreign</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">Foreign</span> <span class="o">*</span><span class="p">)</span> <span class="n">someMethod</span><span class="p">;</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">_foreign</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p><strong>@defs</strong> is available and great for writing fast accessors, when you don’t want
your instance variables to be <strong>@public</strong>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="n">Foreign</span>  <span class="o">*</span><span class="nf">FooGetForeign</span><span class="p">(</span> <span class="n">Foo</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">((</span><span class="k">struct</span><span class="p">{</span> <span class="err">@defs</span><span class="p">(</span> <span class="n">Foo</span><span class="p">);</span> <span class="p">}</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_foreign</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="compatibility_alias">@compatibility_alias</h4>

<p><strong>@compatibility_alias</strong> will work as expected.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// use Foo under alias Foobar</span>
<span class="err">@compatibility</span><span class="n">_alias</span> <span class="n">Foobar</span> <span class="n">Foo</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="protocolclasses">Protocolclasses</h3>

<p>You can declare <a href="protocolclass.html">protocolclasses</a>. This is a
mulle-objc extension to the Objective-C language. Protocolclasses will not work
on other runtimes (though they will compile):</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// protocolclass Description with default implementation of -description</span>
<span class="k">@class</span> <span class="nc">Description</span><span class="p">;</span>
<span class="k">@protocol</span> <span class="nc">Description</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">description</span><span class="p">;</span>

<span class="c1">// properties can not be declared in protocolclases yet</span>
<span class="c1">// @property( assign) NSUInteger  value;</span>
<span class="k">@end</span>
<span class="cp">#pragma clang diagnostic ignored "-Wobjc-root-class"
</span>
<span class="c1">// protocolclass must implement Protocol of same name</span>
<span class="k">@interface</span> <span class="nc">Description</span><span class="o">&lt;</span> <span class="n">Description</span><span class="o">&gt;</span>
<span class="k">@end</span>

<span class="c1">// implementation will serve the default implementation of description</span>
<span class="k">@implementation</span> <span class="nc">Description</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">description</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="s">@"VfL Bochum 1848"</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>Your classes can now inherit the description protocol, but it doesn’t have to
implement <code class="language-plaintext highlighter-rouge">-description</code>. It can override it though if desired:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">Bar</span> <span class="p">:</span> <span class="nc">Foo</span> <span class="o">&lt;</span> <span class="n">Description</span><span class="o">&gt;</span>
<span class="k">@end</span>


<span class="k">@implementation</span> <span class="nc">Bar</span>

<span class="c1">// call super on protocolclass (not superclass)</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">description</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">super</span> <span class="nf">description</span><span class="p">]);</span>  <span class="c1">// unvoidable warning for now</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="keywords">Keywords</h3>

<h4 id="protocol-1">PROTOCOL</h4>

<p><strong>PROTOCOL</strong> is a compiler keyword. Objective-C’s <code class="language-plaintext highlighter-rouge">Protocol *</code> does not work, as
PROTOCOL is a kind of <strong>@selector</strong> in mulle-objc:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">knowsThisProtocol</span><span class="p">:(</span><span class="n">PROTOCOL</span><span class="p">)</span> <span class="n">proto</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="k">@protocol</span><span class="err">(</span> <span class="nc">Description</span><span class="p">)</span> <span class="o">==</span> <span class="n">proto</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="instancetype">instancetype</h4>

<p><strong>instancetype</strong> is a standin for <code class="language-plaintext highlighter-rouge">id</code> the generic object pointer:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// instancetype keyword</span>
<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="encode">@encode</h4>

<p><strong>@encode</strong> behaves normally and is 90% compatible with the Apple runtime:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @encode keyword</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">type</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="k">@encode</span><span class="p">(</span> <span class="n">Bar</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="autoreleasepool">@autoreleasepool</h4>

<p>You can use <strong>@autoreleasepool</strong> to create nested pool structures:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// keyword autoreleasepool</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">autoreleasepool</span>
<span class="p">{</span>
   <span class="k">@autoreleasepool</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="try-">@try …</h4>

<p>Exception handling can be done with <strong>@try</strong>,<strong>@catch</strong>,<strong>@finally</strong>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">trycatchfinally</span>
<span class="p">{</span>
   <span class="k">@try</span>
   <span class="p">{</span>
   <span class="p">}</span>
   <span class="k">@catch</span><span class="p">(</span> <span class="n">NSException</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
   <span class="p">{</span>
   <span class="p">}</span>
   <span class="k">@finally</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="ns_during-">NS_DURING …</h4>

<p>Or with old-skool  <strong><code class="language-plaintext highlighter-rouge">NS_DURING</code></strong>,<strong><code class="language-plaintext highlighter-rouge">NS_HANDLER</code></strong>,<strong><code class="language-plaintext highlighter-rouge">NS_ENDHANDLER</code></strong>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// exception handling with nsduring</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">nsduring</span>
<span class="p">{</span>
<span class="n">NS_DURING</span>
<span class="n">NS_HANDLER</span>
   <span class="p">[</span><span class="n">localException</span> <span class="nf">raise</span><span class="p">];</span>
<span class="n">NS_ENDHANDLER</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="literals">Literals</h3>

<p>Literals are supported <em>except</em> <strong>@YES</strong> and <strong>@NO</strong>, but boxed versions of those are fine.</p>

<h4 id="18481848ayes">@1848,@18.48,@’A’,@(YES)</h4>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalInteger</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="mi">@1848</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalDouble</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="mf">@18.48</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalCharacter</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="sc">@'A'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalBOOL</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="err">@</span><span class="p">(</span><span class="nb">YES</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="-and-">@{} and @[]</h4>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalDictionary</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">@{</span> <span class="s">@"VfL Bochum"</span> <span class="o">:</span> <span class="mi">@1848</span> <span class="p">});</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalArray</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">@[</span> <span class="mi">@1848</span><span class="p">,</span> <span class="s">@"VfL Bochum"</span> <span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="protocol-2">@protocol</h4>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">PROTOCOL</span><span class="p">)</span> <span class="n">literalProtocol</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="k">@protocol</span><span class="err">(</span> <span class="nc">Description</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="selector">@selector</h4>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">SEL</span><span class="p">)</span> <span class="n">literalSelector</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">whatever</span><span class="o">:</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="fast-enumeration">Fast Enumeration</h3>

<p><em>Fast Enumeration</em> is supported:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// fast enumeration</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">fastEnumerate</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span> <span class="n">array</span>
<span class="p">{</span>
   <span class="k">for</span><span class="p">(</span> <span class="n">id</span> <span class="n">p</span> <span class="k">in</span> <span class="n">array</span><span class="p">)</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<blockquote>
  <p>Checked against the list of <a href="https://nshipster.com/at-compiler-directives/">NSHipster’s compiler directive</a></p>
</blockquote>

<h2 id="putting-all-the-pieces-together">Putting all the pieces together</h2>

<p>Run the <code class="language-plaintext highlighter-rouge">main</code> function, to verify the truth of what’s been written (<a href="files/good-code.m">good-code.m</a>).</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">Bar</span>   <span class="o">*</span><span class="n">bar</span><span class="p">;</span>

   <span class="n">bar</span> <span class="o">=</span> <span class="p">[</span><span class="n">Bar</span> <span class="nf">object</span><span class="p">];</span>

   <span class="p">[</span><span class="n">bar</span> <span class="nf">fastEnumerate</span><span class="p">:[</span><span class="n">NSArray</span> <span class="nf">arrayWithObject</span><span class="p">:</span><span class="s">@"foo"</span><span class="p">]];</span>

   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"description       : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">description</span><span class="p">]);</span>
   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalInteger    : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalInteger</span><span class="p">]);</span>
   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalDouble     : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalDouble</span><span class="p">]);</span>
   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalCharacter  : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalCharacter</span><span class="p">]);</span>
   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalArray      : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalArray</span><span class="p">]);</span>
   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalDictionary : %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalDictionary</span><span class="p">]);</span>

<span class="c1">// NSStringFromProtocol is a 8.0.0 feature</span>
<span class="cp">#if MULLE_FOUNDATION_VERSION  &gt;= ((0 &lt;&lt; 20) | (15 &lt;&lt; 8) | 0)
</span>   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalProtocol   : %@"</span><span class="p">,</span> <span class="n">NSStringFromProtocol</span><span class="p">(</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalProtocol</span><span class="p">]));</span>
<span class="cp">#endif
</span>   <span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"literalSelector   : %@"</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span> <span class="p">[</span><span class="n">bar</span> <span class="nf">literalSelector</span><span class="p">]));</span>

   <span class="k">return</span><span class="p">(</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="expected-output">Expected output</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">description:</span> <span class="n">VfL</span> <span class="n">Bochum</span> <span class="mi">1848</span>
<span class="n">literalInteger</span><span class="o">:</span> <span class="mi">1848</span>
<span class="n">literalDouble</span><span class="o">:</span> <span class="mi">18</span><span class="p">.</span><span class="mi">480000</span>
<span class="n">literalCharacter</span><span class="o">:</span> <span class="mi">65</span>
<span class="n">literalArray</span><span class="o">:</span> <span class="p">(</span>
    <span class="mi">1848</span><span class="p">,</span>
    <span class="n">VfL</span> <span class="n">Bochum</span>
<span class="p">)</span>
<span class="n">literalDictionary</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">VfL</span> <span class="n">Bochum</span> <span class="o">=</span> <span class="mi">1848</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">literalSelector</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">invalid</span> <span class="n">selector</span><span class="o">&gt;</span>
</code></pre></div></div>

             
             <div class="pagebreak"></div>
             
         
             <h1>A complete class</h1>
             <p>Lets write a mulle-objc class that highlights all the basics of memory management
and being a good class in the mulle-objc runtime. Some of the topics are seldom
employed in the average Objective-C class, but it’s good to be aware of them.</p>

<p>The main takeaway points are</p>

<ul>
  <li>use <code class="language-plaintext highlighter-rouge">-release</code> only in <code class="language-plaintext highlighter-rouge">-init</code> and <code class="language-plaintext highlighter-rouge">-dealloc</code></li>
  <li>use <code class="language-plaintext highlighter-rouge">-autorelease</code> everywhere else</li>
  <li>protect your setters with <code class="language-plaintext highlighter-rouge">NSParameterAssert</code> (if using Foundation, else use <code class="language-plaintext highlighter-rouge">assert</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">+load</code> and <code class="language-plaintext highlighter-rouge">+initialize</code> behave as expected if you declare <code class="language-plaintext highlighter-rouge">MULLE_OBJC_DEPENDS_ON_LIBRARY</code></li>
  <li>try to write proper <code class="language-plaintext highlighter-rouge">+unload</code> and <code class="language-plaintext highlighter-rouge">+deinitialize</code> methods to be a well behaved class, that doesn’t leak in tests</li>
  <li>ARC is not compatible with mulle-objc, use manual <code class="language-plaintext highlighter-rouge">-retain/-release/-autorelease</code> memory management methods</li>
</ul>

<h2 id="foo-does-it-all">Foo does it all</h2>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="p">{</span>
   <span class="n">NSNumber</span>   <span class="o">*</span><span class="n">_a</span><span class="p">;</span>
   <span class="n">NSArray</span>    <span class="o">*</span><span class="n">_kids</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@property</span><span class="p">(</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="nf">lookup</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">addToKids</span><span class="p">:(</span><span class="n">Foo</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span>

<span class="k">@end</span>


<span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="c1">// class variables are declared as static. It's somewhat convenient to wrap</span>
<span class="c1">// these into a struct. In most cases you will need to protect your class</span>
<span class="c1">// variables with a lock.</span>

<span class="k">static</span> <span class="k">struct</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_t</span>   <span class="n">_lock</span><span class="p">;</span>

<span class="c1">// mutable, needs locking</span>
   <span class="n">NSMutableDictionary</span>    <span class="o">*</span><span class="n">_lookupTable</span><span class="p">;</span>

<span class="c1">// immutable, need no locking</span>
   <span class="n">Class</span>                  <span class="n">_FooClass</span><span class="p">;</span>
   <span class="kt">char</span>                   <span class="o">*</span><span class="n">_info</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Self</span><span class="p">;</span>


<span class="c1">// Ensure that Foundation is loaded completely before our class</span>
<span class="n">MULLE_OBJC_DEPENDS_ON_LIBRARY</span><span class="p">(</span> <span class="n">Foundation</span><span class="p">);</span>

<span class="c1">// run as soon as class is added to the runtime</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">load</span>
<span class="p">{</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_FooClass</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>

   <span class="n">mulle_thread_mutex_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// run when the universe winds down</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">unload</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_done</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// run when the class is messaged for the first time</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">initialize</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="o">=</span> <span class="p">[@{</span> <span class="s">@"a"</span><span class="o">:</span> <span class="mi">@1</span><span class="p">,</span>
                              <span class="s">@"b"</span><span class="o">:</span> <span class="mi">@2</span><span class="p">,</span>
                              <span class="s">@"c"</span><span class="o">:</span> <span class="mi">@3</span>
                            <span class="p">}</span> <span class="nf">mutableCopy</span><span class="p">];</span>
      <span class="n">Self</span><span class="p">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">mulle_strdup</span><span class="p">(</span> <span class="s">"some text"</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// run when the universe winds down (before unload)</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">deinitialize</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="nf">release</span><span class="p">];</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
   <span class="n">mulle_free</span><span class="p">(</span> <span class="n">Self</span><span class="p">.</span><span class="n">_info</span><span class="p">);</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">+</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="nf">lookup</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span>
<span class="p">{</span>
   <span class="n">NSNumber</span>   <span class="o">*</span><span class="n">value</span><span class="p">;</span>

   <span class="n">mulle_thread_mutex_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
   <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">key</span><span class="p">];</span>
      <span class="n">value</span> <span class="o">=</span> <span class="p">[[</span><span class="n">value</span> <span class="nf">retain</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="p">}</span>
   <span class="n">mulle_thread_mutex_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
   <span class="n">_a</span>    <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumber</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithInt</span><span class="p">:</span><span class="mi">18</span><span class="p">];</span>
   <span class="n">_b</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">@48</span> <span class="nf">retain</span><span class="p">];</span>
   <span class="n">_kids</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">]</span> <span class="nf">retain</span><span class="p">];</span>

   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// run before dealloc, can be triggered with -performFinalize</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">finalize</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">_kids</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="n">_kids</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

   <span class="p">[</span><span class="n">super</span> <span class="nf">finalize</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dealloc</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">_a</span> <span class="nf">release</span><span class="p">];</span>
   <span class="p">[</span><span class="n">super</span> <span class="nf">dealloc</span><span class="p">];</span>
<span class="p">}</span>


<span class="c1">// typical value/toOne setter code</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">setA</span><span class="p">:(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="n">NSParameterAssert</span><span class="p">(</span> <span class="o">!</span> <span class="n">a</span> <span class="o">||</span> <span class="p">[</span><span class="n">a</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">NSNumber</span> <span class="nf">class</span><span class="p">]]);</span>

   <span class="p">[</span><span class="n">_a</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="n">_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="nf">copy</span><span class="p">];</span>
<span class="p">}</span>


<span class="c1">// typical getter code</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">_a</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// typical toMany setter code</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">addToKids</span><span class="p">:(</span><span class="n">Foo</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="n">NSParameterAssert</span><span class="p">(</span> <span class="p">[</span><span class="n">a</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">Foo</span> <span class="nf">class</span><span class="p">]]);</span>
   <span class="p">[</span><span class="n">_kids</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">a</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">@end</span>
</code></pre></div></div>

<h2 id="analysing-foo-step-by-step">Analysing Foo step by step</h2>

<h3 id="mulle_objc_depends_on_library">MULLE_OBJC_DEPENDS_ON_LIBRARY</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Ensure that Foundation is loaded completely before our class</span>
<span class="n">MULLE_OBJC_DEPENDS_ON_LIBRARY</span><span class="p">(</span> <span class="n">Foundation</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">MULLE_OBJC_DEPENDS_ON_LIBRARY</code> is only required if you are implementing
<code class="language-plaintext highlighter-rouge">+load</code>, <code class="language-plaintext highlighter-rouge">+unload</code>, <code class="language-plaintext highlighter-rouge">+initialize</code>, <code class="language-plaintext highlighter-rouge">+deinitialize</code>.</p>

<p>This will ensure that classes of the named library have been loaded, so that
your code will work as expected. You should usually specify <strong>Foundation</strong>
at least.</p>

<p>If you want to specify classes and categories in a more finegrained way, see
<a href="dependencies.html">dependencies</a>.</p>

<h3 id="load">+load</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// run as soon as class is added to the runtime</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">load</span>
<span class="p">{</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_FooClass</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>

   <span class="n">mulle_thread_mutex_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Load is executed as soon as your class or category is loaded. Things to
consider are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">main</code> has most likely not run yet</li>
  <li>you must not call <code class="language-plaintext highlighter-rouge">+[super load]</code></li>
  <li><code class="language-plaintext highlighter-rouge">+load</code> is called for classes and categories</li>
</ul>

<p>Ideally your <code class="language-plaintext highlighter-rouge">+load</code> method just calls <strong>C</strong> functions. This is also the best
time to hack mulle-objc runtime methods if you so desire.</p>

<h3 id="unload">+unload</h3>

<p><code class="language-plaintext highlighter-rouge">+unload</code> is mulle-objc specific and does not exist in other runtimes. The
mulle-objc Objective-C runtime is contained in a “universe”, that is
destructible. So <code class="language-plaintext highlighter-rouge">+unload</code> is a facility to release resources acquired by
<code class="language-plaintext highlighter-rouge">+load</code>. When this is properly done by all classes, it makes memory leak
checking that much more convenient.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">unload</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_done</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">Self</span><span class="p">.</span><span class="n">_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="initialize">+initialize</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">initialize</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="o">=</span> <span class="p">[@{</span> <span class="s">@"a"</span><span class="o">:</span> <span class="mi">@1</span><span class="p">,</span>
                              <span class="s">@"b"</span><span class="o">:</span> <span class="mi">@2</span><span class="p">,</span>
                              <span class="s">@"c"</span><span class="o">:</span> <span class="mi">@3</span>
                            <span class="p">}</span> <span class="nf">mutableCopy</span><span class="p">];</span>
      <span class="n">Self</span><span class="p">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">mulle_strdup</span><span class="p">(</span> <span class="s">"some text"</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">+intialize</code> is the best time to instantiate class variables, that are defined
as static variables.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">+initialize</code> is only called for classes not for categories</li>
  <li>your <code class="language-plaintext highlighter-rouge">+initialize</code> is called by subclasses, if they don’t implement <code class="language-plaintext highlighter-rouge">+initialize</code> themselves</li>
  <li>it is OK for subclasses to call <code class="language-plaintext highlighter-rouge">+[super initialize]</code> if a superclass defines it</li>
  <li>your class will get it’s <code class="language-plaintext highlighter-rouge">+initialize</code> call first before subclasses</li>
  <li><code class="language-plaintext highlighter-rouge">+initialize</code> is single-threaded, so you don’t need to lock</li>
  <li><code class="language-plaintext highlighter-rouge">+initialize</code> will be called for subclasses, that do not define their own <code class="language-plaintext highlighter-rouge">+initialize</code> method</li>
</ul>

<p>To avoid leaks, check if your variables aren’t already initialized.</p>

<h3 id="deinitialize">+deinitialize</h3>

<p><code class="language-plaintext highlighter-rouge">+deinitialize</code> is only called if <code class="language-plaintext highlighter-rouge">+initialize</code> has been called. If you did not
implement <code class="language-plaintext highlighter-rouge">+initialize</code> then <code class="language-plaintext highlighter-rouge">+deinitialize</code> has no effect.</p>

<p>You should release all resources, that were allocated during <code class="language-plaintext highlighter-rouge">+initialize</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">+deinitialize</code> is only called for classes not for categories</li>
  <li>it is OK for subclasses to call <code class="language-plaintext highlighter-rouge">+[super deinitialize]</code> if a superclass defines it</li>
  <li>subclasses will get the <code class="language-plaintext highlighter-rouge">+deinitialize</code> call first before their superclass (!)</li>
  <li><code class="language-plaintext highlighter-rouge">+deinitialize</code> is running single-threaded</li>
</ul>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">deinitialize</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="nf">release</span><span class="p">];</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_lookupTable</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
   <span class="n">mulle_free</span><span class="p">(</span> <span class="n">Self</span><span class="p">.</span><span class="n">_info</span><span class="p">);</span>
   <span class="n">Self</span><span class="p">.</span><span class="n">_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To avoid crashes, zero your variables after freeing them.</p>

<h3 id="-init">-init</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
   <span class="n">_a</span>    <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumber</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithInt</span><span class="p">:</span><span class="mi">18</span><span class="p">];</span>
   <span class="n">_b</span>    <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumber</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithInt</span><span class="p">:</span><span class="mi">48</span><span class="p">];</span>
   <span class="n">_kids</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">]</span> <span class="nf">retain</span><span class="p">];</span>

   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Calling <code class="language-plaintext highlighter-rouge">-[super init]</code> if <code class="language-plaintext highlighter-rouge">NSObject</code> is the direct superclass is superflous
and can be avoided. mulle-objc uses manual retain counting, so <code class="language-plaintext highlighter-rouge">-retain</code> what
needs to be retained by the instance.</p>

<h3 id="-finalize">-finalize</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">finalize</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">_kids</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="n">_kids</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

   <span class="p">[</span><span class="n">super</span> <span class="nf">finalize</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">-finalize</code> is the time, when properties release their values. If you are
keeping references to other objects, that aren’t simple values like <code class="language-plaintext highlighter-rouge">NSString</code>
this is the time to release them. The separation of <code class="language-plaintext highlighter-rouge">-dealloc</code> and <code class="language-plaintext highlighter-rouge">-finalize</code>
can be useful to break retain cycles.</p>

<p>Set <code class="language-plaintext highlighter-rouge">nil</code> to your instance variables, as the object is still alive.</p>

<p>A finalized object can still be messaged, but an object can only be
finalized once.</p>

<h3 id="-dealloc">-dealloc</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dealloc</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">_a</span> <span class="nf">release</span><span class="p">];</span>
   <span class="p">[</span><span class="n">super</span> <span class="nf">dealloc</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Non property instance variables should be freed manually. You can do this
also in <code class="language-plaintext highlighter-rouge">-finalize</code>, but often an object needs some values until the very end.</p>

<h3 id="lookup">+lookup:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ (NSNumber *) lookup:(NSString *) key
{
   NSNumber   *value;

   mulle_thread_mutex_lock( &amp;Self._lock);
   {
      value = [Self._lookupTable objectForKey:key];
      value = [[value retain] autorelease]; // if
   }
   mulle_thread_mutex_unlock( &amp;Self._lock);
   return( value);
}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">+lookup</code> accesses a mutable class variable, therefore you should protect
the contents with a lock. You should also <code class="language-plaintext highlighter-rouge">retain</code>/<code class="language-plaintext highlighter-rouge">autorelease</code> the return
value inside the lock, to push the value into the current threads
autoreleasepool.</p>

<h3 id="-seta">-setA:</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">setA</span><span class="p">:(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="n">NSParameterAssert</span><span class="p">(</span> <span class="o">!</span> <span class="n">a</span> <span class="o">||</span> <span class="p">[</span><span class="n">a</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">NSNumber</span> <span class="nf">class</span><span class="p">]]);</span>

   <span class="p">[</span><span class="n">_a</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="n">_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="nf">copy</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Protect setters with <code class="language-plaintext highlighter-rouge">NSParameterAssert</code>. Allow <code class="language-plaintext highlighter-rouge">nil</code> to be set whenever
possible.</p>

<p>All code outside of <code class="language-plaintext highlighter-rouge">+load</code>/<code class="language-plaintext highlighter-rouge">+unload</code> <code class="language-plaintext highlighter-rouge">+initialize</code>/<code class="language-plaintext highlighter-rouge">+deinitialize</code>
<code class="language-plaintext highlighter-rouge">-init</code>/<code class="language-plaintext highlighter-rouge">-dealloc</code> must use <strong><code class="language-plaintext highlighter-rouge">-autorelease</code></strong>.
The only allowable use of <code class="language-plaintext highlighter-rouge">-release</code> is for ephemeral objects like in:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">Foo</span> <span class="nf">new</span><span class="p">];</span>
   <span class="p">...</span>
   <span class="p">[</span><span class="n">p</span> <span class="nf">release</span><span class="p">];</span>
   <span class="c1">// p is never used again in this function</span>
</code></pre></div></div>

<h3 id="-a">-a</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">_a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Because of the strict use of <code class="language-plaintext highlighter-rouge">-autorelease</code> in the setters, we don’t have to
do <code class="language-plaintext highlighter-rouge">[[obj retain] autorelease]</code> shenanigans, but can just return the instance
variable.</p>

<h3 id="-addtokids">-addToKids:</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">addToKids</span><span class="p">:(</span><span class="n">Foo</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span>
<span class="p">{</span>
   <span class="n">NSParameterAssert</span><span class="p">(</span> <span class="p">[</span><span class="n">a</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">Foo</span> <span class="nf">class</span><span class="p">]]);</span>
   <span class="p">[</span><span class="n">_kids</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">a</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can not add <em>nil</em> to an array. And as <code class="language-plaintext highlighter-rouge">_kids</code> is a
<code class="language-plaintext highlighter-rouge">NSMutableArray</code> this will raise. The assert ensures that
<code class="language-plaintext highlighter-rouge">a</code> of the proper class.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Objects and Properties</h1>
             <p>Objects or in this case more exactly instance and their properties are the fundamental storage units for object-oriented programming in the language. They serve as the basic containers for data and behavior in Objective-C
applications.</p>

<p>Because this is an important topic, there are actually two complementary guides
that give all the information needed to manage objects and how to implement
their properties.</p>

<ul>
  <li><a href="//www.mulle-kybernetik.com/de-re-nsobject">De Re NSObject</a></li>
  <li><a href="//www.mulle-kybernetik.com/de-re-property">De Re @property</a></li>
</ul>


             
             <div class="pagebreak"></div>
             
         
             <h1>Printing</h1>
             <h2 id="intro">Intro</h2>

<p>The C way to print anything to a file, the console or even to memory
is <code class="language-plaintext highlighter-rouge">printf</code> and friend functions which are defined in <code class="language-plaintext highlighter-rouge">&lt;stdio.h&gt;</code>. <code class="language-plaintext highlighter-rouge">printf</code> is still absolutely viable with mulle-objc. To print an object with standard
printf, you would use the objects <code class="language-plaintext highlighter-rouge">-UTF8String</code> method:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="n">obj</span> <span class="n">UTF8String</span><span class="p">]);</span>
</code></pre></div></div>

<p>But when objects are involved it is more convenient to use the
<code class="language-plaintext highlighter-rouge">mulle_printf</code> family of functions. <code class="language-plaintext highlighter-rouge">mulle_printf</code> allows the special ‘%@’
object conversion. This simplifies the code to:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mulle_printf</span><span class="p">(</span> <span class="s">"%@</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
</code></pre></div></div>

<p>Technically the same thing happens as in the printf example: the <code class="language-plaintext highlighter-rouge">-UTF8String</code> method of <strong>obj</strong> is called and the result is used to replace <code class="language-plaintext highlighter-rouge">%@</code>.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> In many Objective-C tutorials you will
see <tt>NSLog</tt> being used instead of printf. This is not a good
replacement though, as <tt>NSLog</tt> actually also writes into the system log.</div>

<h2 id="functions-with-c-format-strings">Functions with C format strings</h2>

<h3 id="functions-with-normal-arguments">Functions with normal arguments</h3>

<table>
  <thead>
    <tr>
      <th>stdio</th>
      <th>mulle</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">printf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_printf</code></td>
      <td>print to stdout</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_fprintf</code></td>
      <td>print to FILE</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">dprintf</code></td>
      <td>-</td>
      <td>print to file descriptor</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">sprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_sprintf</code></td>
      <td>print to “big enough” char buffer</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">snprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_snprintf</code></td>
      <td>print to char buffer of given size</td>
    </tr>
  </tbody>
</table>

<p>There are some non-POSIX extensions which are available on BSD and Linux for C.
The mulle functions are available on all platforms.</p>

<table>
  <thead>
    <tr>
      <th>stdio</th>
      <th>mulle</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">asprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_asprintf</code></td>
      <td>allocate char buffer and print to char buffer of given size with varargs (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vasprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_vasprintf</code></td>
      <td>allocate char buffer and print to char buffer of given size with varargs (C)</td>
    </tr>
  </tbody>
</table>

<h3 id="functions-with-c-varargs">Functions with C varargs</h3>

<p>The <code class="language-plaintext highlighter-rouge">vprintf</code> variants accept stdarg parameters. This is convenient for
forwarding arguments in a C function, that itself accepts variable arguments.</p>

<table>
  <thead>
    <tr>
      <th>stdio</th>
      <th>mulle</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_vprintf</code></td>
      <td>print to stdout with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vfprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_vfprintf</code></td>
      <td>print to FILE with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vdprintf</code></td>
      <td>-</td>
      <td>print to file descriptor with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vsprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_vsprintf</code></td>
      <td>print to “big enough” char buffer with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vsnprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">mulle_vsnprintf</code></td>
      <td>print to char buffer of given size with stdarg (C)</td>
    </tr>
  </tbody>
</table>

<h3 id="functions-with-mulle-varargs">Functions with mulle-varargs</h3>

<p>Methods with variable arguments don’t receive stdarg arguments but
mulle-varargs arguments. There is support for this as well.</p>

<table>
  <thead>
    <tr>
      <th>Function</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvprintf</code></td>
      <td>print to stdout with mulle-varargs (Objective-C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvfprintf</code></td>
      <td>print to FILE with mulle-varargs (Objective-C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvsprintf</code></td>
      <td>print to “big enough” char buffer with mulle-varargs (Objective-C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvsnprintf</code></td>
      <td>print to char buffer of given size with mulle-varargs (Objective-C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvasprintf</code></td>
      <td>allocate char buffer and print with mulle-varargs (Objective-C)</td>
    </tr>
  </tbody>
</table>

<h3 id="functions-printing-into-autoreleased-c-strings">Functions printing into autoreleased C strings</h3>

<p>With <code class="language-plaintext highlighter-rouge">asprintf</code> a <code class="language-plaintext highlighter-rouge">malloc</code>ed string is returned. The caller should
<code class="language-plaintext highlighter-rouge">free</code> this string eventually. Wouldn’t it be convenient, if the string was
already autoreleased, so the caller wouldn’t have to free it ?</p>

<p>You can create such autoreleases C strings like so:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span>   <span class="o">*</span><span class="n">s</span><span class="p">;</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">MulleObjC_asprintf</span><span class="p">(</span> <span class="s">"%d"</span><span class="p">,</span> <span class="mi">1848</span><span class="p">);</span>
</code></pre></div></div>

<p>The following mulle functions create autoreleased C strings:</p>

<table>
  <thead>
    <tr>
      <th>Function</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MulleObjC_asprintf</code></td>
      <td>allocate autoreleased char buffer and print to it</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MulleObjC_vasprintf</code></td>
      <td>allocate autoreleased char buffer and print to it with varargs (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MulleObjC_mvasprintf</code></td>
      <td>allocate autoreleased char buffer and print to it with mulle-varargs (Objective-C)</td>
    </tr>
  </tbody>
</table>

<h2 id="functions-with-objective-c-format-strings">Functions with Objective-C format strings</h2>

<p><code class="language-plaintext highlighter-rouge">MulleObjCPrintf( @"%@\n", @VfL Bochum 1848")</code> is basically the same as
<code class="language-plaintext highlighter-rouge">mulle_printf( ["@%s\n" UTF8String], @"VfL Bochum 1848\n")</code>.</p>

<p>MulleObjC supports Objective-C format strings with the following functions:</p>

<table>
  <thead>
    <tr>
      <th>C</th>
      <th>Objective-C</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_printf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCPrintf</code></td>
      <td>print to stdout</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_vprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCVPrintf</code></td>
      <td>print to stdout with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCVPrintf</code></td>
      <td>print to stdout with mulle-vararg (Objective-C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_fprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCFPrintf</code></td>
      <td>print to FILE</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_vfprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCVPrintf</code></td>
      <td>print to FILE with stdarg (C)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mulle_mvfprintf</code></td>
      <td><code class="language-plaintext highlighter-rouge">MulleObjCMVPrintf</code></td>
      <td>print to FILE with mulle-vararg (Objective-C)</td>
    </tr>
  </tbody>
</table>

<p>For all other purposes use the <code class="language-plaintext highlighter-rouge">NSString stringWithFormat:</code> methods.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Plug And Play Class</h1>
             <p>A category might need to do a little more to install itself into the
class system, we’ll show how in the next example. Here we will be extending
<code class="language-plaintext highlighter-rouge">NSDateFormatter</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">NSDateFormatter</code> has several build-in behaviors that are specified by <code class="language-plaintext highlighter-rouge">NSDateFormatterBehavior10_0</code> or <code class="language-plaintext highlighter-rouge">NSDateFormatterBehavior10_4</code>.</p>

<p>We’d like to extend this with a custom behavior <code class="language-plaintext highlighter-rouge">MyDateFormatterBehavior</code> and
here is how to do it.</p>

<h2 id="create-a-subclass-of-nsdateformatter">Create a subclass of NSDateFormatter</h2>

<p>This will implement the desired behavior. How this is implemented is not
shown. Lets just assume it’s a class called <code class="language-plaintext highlighter-rouge">MyDateFormatter</code>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">MyDateFormatter</span> <span class="p">:</span> <span class="nc">NSDateFormatter</span>
<span class="p">...</span>
</code></pre></div></div>

<h2 id="patch-class-into-nsdateformatter">Patch class into NSDateFormatter</h2>

<p>NSDateFormatter has an extension mechanism in place called <code class="language-plaintext highlighter-rouge">+mulleSetClass:forFormatterBehavior:</code>,
where we associate a custom class with the behavior.</p>

<p>We would like to do this ASAP, which is when our custom class gets loaded into
the runtime. <code class="language-plaintext highlighter-rouge">+load</code> will have to be used, since no one will be calling our
class directly.</p>

<p>The only thing we need to advertise to the user is our new constant value
<code class="language-plaintext highlighter-rouge">MyDateFormatterBehavior</code> in a header somewhere for the new behavior:</p>

<p>Now comes the bad news, which is: it can be tricky.
The following implementation is correct, but you have to know why.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">MyDateFormatter</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">load</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">NSDateFormatter</span> <span class="nf">mulleSetClass</span><span class="p">:</span><span class="n">self</span>
             <span class="nl">forFormatterBehavior:</span><span class="n">MyDateFormatterBehavior</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>As long as you are not using any other Objective-C class except your own class
and its superclasses, your code is safe. But as soon you are using another
class, even just <code class="language-plaintext highlighter-rouge">@"some constant string"</code> then you have to declare its usage
beforehand. This can be tricky, when class-clusters come into play, where you
may not even know the class (<code class="language-plaintext highlighter-rouge">NSConstantString</code> in this case for instance).
Even worse, if you are messaging another class, this in turn may message other
classes. And that may be hard to predict and maintain.</p>

<p>Fortunately you can declare a dependency on libraries, which in most cases
should be <strong>Foundation</strong> or some equivalent.</p>

<p>Adding</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MULLE_OBJC_DEPENDS_ON_LIBRARY</span><span class="p">(</span> <span class="n">Foundation</span><span class="p">);</span>
</code></pre></div></div>

<p>before the <code class="language-plaintext highlighter-rouge">+load</code> method definition will be sufficient in most cases.</p>

<blockquote>
  <p>See bla bla for in depth</p>
</blockquote>


             
             <div class="pagebreak"></div>
             
         
             <h1>Plug And Play Category</h1>
             <p>The category is the original plug and play mechanism of Objective-C. With it
you can augment existing classes. Here we do a more complicated kind of
extension, than what you are likely to encounter when dealing categories.</p>

<h2 id="extending-a-class-cluster">Extending a class cluster</h2>

<blockquote>
  <p>See <a href="//developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/ClassCluster.html">Class cluster</a> for an introduction on
class clusters.</p>
</blockquote>

<p>A class cluster is a class collection of one <em>placeholder</em> class and one or
more <em>concrete</em> subclasses. The subclasses are not advertised in headers, but
are created by the placeholder and substitute it.</p>

<p>A typical class cluster is <code class="language-plaintext highlighter-rouge">NSString</code>, to which we will add a subclass now.</p>

<h3 id="extend-the-placeholder-class">Extend the placeholder class</h3>

<p>We will extend <code class="language-plaintext highlighter-rouge">NSString</code> to natively carry EBCDIC characters.</p>

<blockquote>
  <p>It makes technically little sense to do this in a subclass of <code class="language-plaintext highlighter-rouge">NSString</code>, but
that’s beside the point here.</p>
</blockquote>

<p>So we define a category on <code class="language-plaintext highlighter-rouge">NSString</code> that advertises a new initializer.
The API user will only see this new method, everything else is hidden from
plain sight. The user will still deal only with the familiar <code class="language-plaintext highlighter-rouge">NSString</code> class:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "import.h"
</span>

<span class="k">typedef</span> <span class="kt">char</span>   <span class="n">EBCDICChar</span><span class="p">;</span>


<span class="k">@interface</span> <span class="nc">NSString</span><span class="p">(</span> <span class="nl">EBCDIC</span><span class="p">)</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithEBCDICCharacters</span><span class="p">:(</span><span class="n">EBCDICChar</span> <span class="o">*</span><span class="p">)</span> <span class="n">characters</span>
                                   <span class="n">length</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">length</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">NSString</code> is actually a placeholder class. In the implementation of the
category, we instantiate a new EBCDICString and return this. We don’t have
to do anything with the placeholder:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "NSString+EBCDIC.h"
</span>
<span class="cp">#import "import-private.h"
</span>
<span class="cp">#import "EBCDICString.h"  // import this here and not in import-private
</span>

<span class="k">@implementation</span> <span class="nc">NSString</span><span class="p">(</span> <span class="nl">EBCDIC</span><span class="p">)</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithEBCDICCharacters</span><span class="p">:(</span><span class="n">EBCDICChar</span> <span class="o">*</span><span class="p">)</span> <span class="n">characters</span>
                                   <span class="n">length</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">length</span>
<span class="p">{</span>
   <span class="n">NSParameterAssert</span><span class="p">(</span> <span class="p">[</span><span class="n">self</span> <span class="nf">__isClassClusterPlaceholderObject</span><span class="p">]);</span>

   <span class="n">self</span> <span class="o">=</span> <span class="p">[[</span><span class="n">EBCDICString</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithEBCDICCharacters</span><span class="p">:</span><span class="n">characters</span>
                                                  <span class="nl">length:</span><span class="n">length</span><span class="p">];</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<blockquote>
  <p>Implementing EBCDICString is left as an exercise to the reader…</p>
</blockquote>

<h2 id="the-end">The End</h2>

<p>This wraps up the basic developer guide. Next up will be more advanced
topics, that will lead you into more esoteric territory.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: Calling overridden methods</h1>
             <blockquote>
  <p>Welcome to the “Advanced” section of “De Re mulle-objc”. This is a deeper
dive into mulle-objc and what it provides.</p>
</blockquote>

<p>In Objective-C the standard way to access an overridden method is a
<code class="language-plaintext highlighter-rouge">super</code> call. The runtime and MulleObjC functions give you more options though.</p>

<p>So check out this little class system for a class <strong>B</strong>:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">B</span> <span class="p">:</span> <span class="nc">A</span> <span class="o">&lt;</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="o">&gt;</span>
<span class="k">@end</span>
<span class="k">@interface</span> <span class="nc">B</span><span class="p">(</span> <span class="nl">X</span><span class="p">)</span>
<span class="k">@end</span>
<span class="k">@interface</span> <span class="nc">B</span><span class="p">(</span> <span class="nl">Y</span><span class="p">)</span> <span class="c1">// depends on X</span>
<span class="k">@end</span>
</code></pre></div></div>

<p><strong>B</strong> has two categories <strong>X</strong> and <strong>Y</strong> (shortend from B( X) and B( Y))
<strong>A</strong> is its superclass and
<strong>P</strong> and <strong>Q</strong> are adopted <a href="protocolclass.html">protocol classes</a>.</p>

<p><img src="../images/class-system.svg" alt="" /></p>

<h2 id="super-foo"><code class="language-plaintext highlighter-rouge">[super foo]</code></h2>

<p>Lets recapitulate how calling a <code class="language-plaintext highlighter-rouge">super</code> method works in this scenario.
Lets put into each class (A, B), protocol class (P, Q) and
category (X, Y) a method named <code class="language-plaintext highlighter-rouge">foo</code> . If possible, <code class="language-plaintext highlighter-rouge">-foo</code> should call
<code class="language-plaintext highlighter-rouge">[super foo]</code>.</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">super</span> <span class="nf">foo</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Calling <code class="language-plaintext highlighter-rouge">super</code> from root classes is impossible. And protocol classes are
always root classes. So <strong>A</strong> a regular root class and
the protocol classes <strong>P</strong>, <strong>Q</strong> will have only empty method bodies.</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When <code class="language-plaintext highlighter-rouge">foo</code> of an instance of <strong>B</strong> is called maybe like so:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>  <span class="nf">example</span><span class="p">(</span> <span class="n">B</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">b</span> <span class="nf">foo</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>the most recently added methodlist closest to the instance class will be
searched first. So <code class="language-plaintext highlighter-rouge">foo</code> of category <strong>Y</strong> will be executed:</p>

<p><img src="../images/super.svg" alt="" /></p>

<p>Our <strong>Y</strong> implementation looks like this:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">B</span><span class="p">(</span> <span class="nl">Y</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">super</span> <span class="nf">foo</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>The call to <code class="language-plaintext highlighter-rouge">super</code> will forego the implementation in all other methodlists
of <strong>B</strong> and will then look for a method in any protocol classes and then
the superclass.</p>

<p>As with the methodlists the protocol classes are searched in reverse order.
Therefore <code class="language-plaintext highlighter-rouge">foo</code> of protocol class <strong>Q</strong> will be found and executed for
<code class="language-plaintext highlighter-rouge">[super foo]</code>.</p>

<p>There the chain ends, as we have reached a root class. So in effect the
methods <code class="language-plaintext highlighter-rouge">foo</code> in <strong>A</strong> or <strong>P</strong> and the <code class="language-plaintext highlighter-rouge">foo</code> methods in <strong>B</strong> and <strong>X</strong> are
unreachable via <code class="language-plaintext highlighter-rouge">super</code>.</p>

<h2 id="mulleobjcoverriddenimp"><code class="language-plaintext highlighter-rouge">MulleObjCOverriddenIMP</code></h2>

<p>With the special macro <code class="language-plaintext highlighter-rouge">MulleObjCOverriddenIMP</code> we can traverse the complete
chain. Let’s implement <code class="language-plaintext highlighter-rouge">foo</code> in all classes, categories and protocol classes
like this:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCOverriddenIMP</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">imp</span><span class="p">)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imp</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Due to its dynamic nature, <code class="language-plaintext highlighter-rouge">foo</code> will only call an overridden implementation, if
one exists.</p>

<p><img src="images/overridden.svg" alt="" /></p>

<p>In our class system the implementation of <code class="language-plaintext highlighter-rouge">foo</code> in <strong>A</strong> will get a NULL value
from <code class="language-plaintext highlighter-rouge">MulleObjCOverriddenIMP</code> and then the call chain stops.</p>

<blockquote>
  <p>Looking up a method with <code class="language-plaintext highlighter-rouge">MulleObjCOverriddenIMP</code> is not very fast though.
If you can use <code class="language-plaintext highlighter-rouge">super</code> use <code class="language-plaintext highlighter-rouge">super</code> instead.</p>
</blockquote>

<h2 id="mulleobjcclobberedimp"><code class="language-plaintext highlighter-rouge">MulleObjCClobberedIMP</code></h2>

<p><code class="language-plaintext highlighter-rouge">MulleObjCClobberedIMP</code> is similiar to <code class="language-plaintext highlighter-rouge">MulleObjCOverriddenIMP</code> but stops at
the class boundary. This can be useful for writing patch categories, if you
can’t subclass for some reason:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCClobberedIMP</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">imp</span><span class="p">)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imp</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="../images/clobbered.svg" alt="" /></p>

<h2 id="mulleobjcclasscategoryimp-and-mulleobjcclassimp"><code class="language-plaintext highlighter-rouge">MulleObjCClassCategoryIMP</code> and <code class="language-plaintext highlighter-rouge">MulleObjCClassIMP</code></h2>

<p>For those special moments, where you want to search for a specific method
in the class hierarchy you can use <code class="language-plaintext highlighter-rouge">MulleObjCClassIMP</code> or
<code class="language-plaintext highlighter-rouge">MulleObjCClassCategoryIMP</code>.</p>

<p>Assume you are writing <code class="language-plaintext highlighter-rouge">-foo</code> in category <strong>Y</strong> and want to call <code class="language-plaintext highlighter-rouge">-foo</code> of
<strong>X</strong>:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCClassCategoryIMP</span><span class="p">(</span> <span class="n">B</span><span class="p">,</span> <span class="n">X</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">imp</span><span class="p">)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imp</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you want to call <code class="language-plaintext highlighter-rouge">-foo</code> of <strong>B</strong>:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCClassIMP</span><span class="p">(</span> <span class="n">B</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">imp</span><span class="p">)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imp</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you want to call <code class="language-plaintext highlighter-rouge">-foo</code> of <strong>A</strong>:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">foo</span>
<span class="p">{</span>
   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCClassIMP</span><span class="p">(</span> <span class="n">A</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">imp</span><span class="p">)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imp</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and so on.</p>

<h2 id="mulleobjcclasssearchinstanceclobberchain"><code class="language-plaintext highlighter-rouge">MulleObjCClassSearchInstanceClobberChain</code></h2>

<p>If a class wants to call all instance methods <code class="language-plaintext highlighter-rouge">foo</code> defined by itself and
its categories, it can use <code class="language-plaintext highlighter-rouge">MulleObjCClassSearchInstanceClobberChain</code>.
This function will add the implementations of <strong>Y</strong>, <strong>X</strong> and <strong>B</strong> to an
array of type <code class="language-plaintext highlighter-rouge">IMP</code> - in that order.</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">B</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">callFoos</span>
<span class="p">{</span>
   <span class="n">IMP</span>            <span class="n">imps</span><span class="p">[</span> <span class="mi">8</span><span class="p">];</span>
   <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

   <span class="n">n</span> <span class="o">=</span> <span class="n">MulleObjCClassSearchInstanceClobberChain</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">foo</span><span class="p">),</span> <span class="n">imps</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
   <span class="n">assert</span><span class="p">(</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">);</span>
   <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">;)</span>
      <span class="n">MulleObjCIMPCall0</span><span class="p">(</span> <span class="n">imps</span><span class="p">[</span> <span class="o">--</span><span class="nf">i</span><span class="p">],</span> <span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">foo</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">callFoos</code> calls the implementations in reverse order, which is often more
useful. Therefore <strong>B</strong>’s foo will be called first, then <strong>X</strong> and then <strong>Y</strong>:</p>

<p><img src="images/chain.svg" alt="" /></p>

<p>There is also a function <code class="language-plaintext highlighter-rouge">MulleObjCClassSearchClobberChain</code> to retrieve
class methods.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: -forward:</h1>
             <div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> See Objective-C Runtime Programming Guide for more information about <code class="language-plaintext highlighter-rouge">NSInvocation</code> and forwarding in general. Most if not all of it is applicable to mulle-objc</div>

<h2 id="introduction">Introduction</h2>

<p>One of the “Patterns” of OO programming is composition. Basically you add
references  to other objects into your object and forward messages to them.
An example of composition would be this:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">MyOrderedDictionary</span> <span class="p">:</span> <span class="nc">NSDictionary</span>
<span class="p">{</span>
   <span class="n">NSDictionary</span>   <span class="o">*</span><span class="n">_other</span><span class="p">;</span>
   <span class="n">NSArray</span>        <span class="o">*</span><span class="n">_order</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">objectAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">objectForKey</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">NSCopying</span><span class="p">)</span> <span class="n">key</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">MyOrderedDictionary</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">_order</span> <span class="nf">count</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">objectAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">_order</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">objectForKey</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">NSCopying</span><span class="p">)</span> <span class="n">key</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">_other</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">key</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>This is nice but can get tedious if you need to implement a lot of methods.</p>

<h3 id="less-typing-with-forwarding-and-nsinvocation">Less typing with forwarding and NSInvocation</h3>

<p>Once you have this code in place, you can forward all unknown method calls to
the array instance but send  <code class="language-plaintext highlighter-rouge">-objectForKey:</code> to the dictionary instance:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">MyOrderedDictionary</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span> <span class="nf">methodSignatureForSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span> <span class="n">sel</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">objectForKey</span><span class="o">:</span><span class="p">))</span>
      <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">_other</span> <span class="nf">methodSignatureForSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">]);</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">_order</span> <span class="nf">methodSignatureForSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">forwardInvocation</span><span class="p">:(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span> <span class="n">anInvocation</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">selector</span><span class="p">]</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">objectForKey</span><span class="o">:</span><span class="p">))</span>
      <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">setTarget</span><span class="p">:</span><span class="n">_other</span><span class="p">];</span>
   <span class="k">else</span>
      <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">setTarget</span><span class="p">:</span><span class="n">_order</span><span class="p">];</span>
   <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">invoke</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>This is still a lot of typing, it’s also slow. It’s not as slow as in the Apple runtime (ca. 10* faster) but
still quite slow.</p>

<h3 id="even-less-typing-with-forward">Even less typing with forward:</h3>

<p>As selectors are a type of integer in <strong>mulle-objc</strong>, we can even use a switch here:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">MyOrderedDictionary</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="nf">forward</span><span class="p">:(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_param</span>
<span class="p">{</span>
   <span class="k">switch</span><span class="p">(</span> <span class="n">_cmd</span><span class="p">)</span>
   <span class="p">{</span>
   <span class="k">case</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">objectForKey</span><span class="p">:)</span> <span class="o">:</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">_other</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

   <span class="nl">default:</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">_order</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">mulle_objc_object_call</span><span class="p">(</span> <span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="n">mulle_objc_methodid_t</span><span class="p">)</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">_param</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>This is way faster than using NSInvocation and the difference to a handcoded forward method
as in the introduction is minimal. This makes composition feasible.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: Protocolclasses allow default implementations</h1>
             <p>A <em>protocolclass</em> is a mulle-objc extension of the Objective-C language. It allows
a class to inherit default implementations from a protocol.</p>

<p><code class="language-plaintext highlighter-rouge">@protocolclass</code> as a keyword doesn’t exist yet, but it’s effect can be
simulated by: <code class="language-plaintext highlighter-rouge">@class Foo; @protocol Foo; @end; @interface Foo &lt;Foo&gt;; @end</code>.</p>

<p>For a class to become a protocolclass it must meet the following
requirements:</p>

<ul>
  <li>it must be a root class (not inherit from another class)</li>
  <li>it must implement the protocol of the same name</li>
  <li>it must not implement any other protocols</li>
  <li>it must not have instance variables</li>
</ul>

<p>Also a protocolclass can not have any categories, this isn’t enforced, but
categories on protocolclass aren’t used by the runtime for method lookup.
The protocol of the protocolclass can adopt other protocols.</p>

<h2 id="a-protocolclass-with-a-default-implementation-of-a-method">A protocolclass with a default implementation of a method</h2>

<p>You can create a protocolclass easily with with mulle-sde:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">mulle-sde add -t protocolclass src/&lt;name&gt;</span>.m
</code></pre></div></div>

<h3 id="future">future</h3>

<p>This is how a <code class="language-plaintext highlighter-rouge">@protocolclass</code> will look like at some point in the future:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@protocolclass</span> <span class="n">Foo</span>
<span class="k">@optional</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">someValue</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="mi">1848</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>The use of <code class="language-plaintext highlighter-rouge">@optional</code> for <code class="language-plaintext highlighter-rouge">-someValue</code> allows it to be used as a default
implementation, where an adopting class does not get a warning, if it doesn’t
implement it. A <code class="language-plaintext highlighter-rouge">@protocolclass</code> must implement the <code class="language-plaintext highlighter-rouge">@optional</code> methods.</p>

<h3 id="now">now</h3>

<p>This is how a protocolclass looks like now, without macros:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@class</span> <span class="nc">Foo</span><span class="p">;</span>
<span class="k">@protocol</span> <span class="nc">Foo</span>
<span class="k">@optional</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">Foo</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">someValue</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="mi">1848</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>The declaration of <code class="language-plaintext highlighter-rouge">@class Foo</code> before <code class="language-plaintext highlighter-rouge">@protocol Foo</code> signals that this is a
protocolclass. Notice how the class <code class="language-plaintext highlighter-rouge">Foo</code> is adopting it’s protocol <code class="language-plaintext highlighter-rouge">Foo</code> of
the same name. It is a root class.</p>

<p>This will give you a number of compiler warnings, due to root classes being
used and so forth.</p>

<h3 id="now-with-macros">now with macros</h3>

<p><code class="language-plaintext highlighter-rouge">PROTOCOLCLASS</code> macros can make your life a little easier, by removing some
typework and by removing the compiler warnings.</p>

<table>
  <thead>
    <tr>
      <th>Macro</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_INTERFACE( name, ...)</code></td>
      <td>Declare a <em>protocolclass</em> that adopts other protocols</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_INTERFACE0( name)</code></td>
      <td>Declare a <em>protocolclass</em> that adopts no other protocols</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_IMPLEMENTATION( name)</code></td>
      <td>Define a <em>protocolclass</em></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_END()</code></td>
      <td>Terminate either a <em>protocolclass</em> declaration or definition</td>
    </tr>
  </tbody>
</table>

<p>Thus the above example can be transformed with macros into:</p>

<p><code class="language-plaintext highlighter-rouge">Foo.h</code>:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PROTOCOLCLASS_INTERFACE0</span><span class="p">(</span> <span class="n">Foo</span><span class="p">)</span>
<span class="k">@optional</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">someValue</span><span class="p">;</span>
<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>

<span class="n">PROTOCOLCLASS_IMPLEMENTATION</span><span class="p">(</span> <span class="n">Foo</span><span class="p">)</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">someValue</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="mi">1848</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>Due to deficiences in the way variadic arguments are handled in C macros, you must use
<code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_INTERFACE0</code> instead of <code class="language-plaintext highlighter-rouge">PROTOCOLCLASS_INTERFACE</code>, if your protocolclass
adopts no further protocols.</p>

<h2 id="a-protocolclass-with-a-property">A protocolclass with a property</h2>

<h3 id="future-1">future</h3>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@protocolclass</span> <span class="n">Foo</span>
<span class="k">@property</span> <span class="kt">int</span>  <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>The adoptingClass will implement the property.</p>

<h3 id="now-1">now</h3>

<p>This is how it looks like now without macros:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@class</span> <span class="nc">Foo</span><span class="p">;</span>
<span class="k">@protocol</span> <span class="nc">Foo</span>
<span class="k">@property</span> <span class="kt">int</span> <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">Foo</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@property</span> <span class="kt">int</span> <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="k">@property</span> <span class="kt">int</span> <span class="n">someValue</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>You must redeclare the property in the adopting class.</p>

<h3 id="now-with-macros-1">now with macros</h3>

<p>Now with even more macros:</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#define FooProperties \
@property int someValue
</span>
<span class="n">PROTOCOLCLASS_INTERFACE0</span><span class="p">(</span> <span class="n">Foo</span><span class="p">)</span>
<span class="n">FooProperties</span><span class="p">;</span>
<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>

<span class="n">PROTOCOLCLASS_IMPLEMENTATION</span><span class="p">(</span> <span class="n">Foo</span><span class="p">)</span>
<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>

<span class="k">@interface</span> <span class="nc">AdoptingClass</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span>
<span class="n">FooProperties</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div></div>

<h2 id="supplement-an-existing-protocol-with-protocolclass-methods">Supplement an existing protocol with protocolclass methods</h2>

<p>When you do this, your protocolclass should adopt that other protocol
and redeclare those methods, for which implementations are provided as
<code class="language-plaintext highlighter-rouge">@optional</code>.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Redeclaration as optional is a mulle-objc specific feature.</div>

<h2 id="calling-nsobject-methods-from-your-protocolclass-methods">Calling NSObject methods from your protocolclass methods</h2>

<p>If your protocolclass wants to use NSObject methods, it should declare this
in its protocol.</p>

<div class="language-objective-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="n">PROTOCOLCLASS_INTERFACE</span><span class="p">(</span> <span class="n">MyProtocolClass</span><span class="p">,</span> <span class="n">NSObject</span><span class="p">)</span>
<span class="k">@optional</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">doSomethingWithObject</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span> <span class="n">object</span><span class="p">;</span>
<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>

<span class="n">PROTOCOLCLASS_IMPLEMENTATION</span><span class="p">(</span> <span class="n">Foo</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">doSomethingWithObject</span><span class="p">:(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">MyProtocolClass</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">object</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">object</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">class</span><span class="p">]]);</span>
<span class="p">}</span>
<span class="n">PROTOCOLCLASS_END</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="things-to-watch-out-for">Things to watch out for</h2>

<h3 id="reaching-the-protocolclass-via-super">Reaching the protocolclass via super</h3>

<p>In the class adopting your protocol, a call to super will first search the protocolclasses in order
of adoption then the superclass, in the case  <code class="language-plaintext highlighter-rouge">MyClass</code> that is <code class="language-plaintext highlighter-rouge">Foo</code> first then <code class="language-plaintext highlighter-rouge">NSObject</code>.</p>

<h3 id="calling-super-from-the-protocolclass">Calling super from the protocolclass</h3>

<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle"></i> <b>Warning:</b> Not recommended!</div>

<p>As a protocolclass is a root class, there is no way to call <strong>super</strong> from a protocolclass. There is a way
around this though.</p>

<p>You can search for the overridden implementation of a selector, given the class and category of the
implementation.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">IMP</span>   <span class="n">imp</span><span class="p">;</span>

   <span class="n">imp</span> <span class="o">=</span> <span class="n">MulleObjCObjectSearchOverriddenIMP</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">doTheFooThing</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">Foo</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">imp</span><span class="p">)(</span> <span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span> <span class="n">doTheFooThing</span><span class="p">),</span> <span class="n">self</span><span class="p">));</span>
</code></pre></div></div>

<p>This works fine, unless the receiver is implementing the same protocolclass again and is calling super.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: Classcluster Classes</h1>
             <h2 id="untested-draft">UNTESTED DRAFT</h2>

<p>A classcluster is a fairly complicated setup, that is used to hide implementation details of various classes under one common name. <strong>mulle-objc</strong> simplifies the setup, but it is by no means simple.</p>

<p>As an example, we want to create a classcluster for a <a href="https://en.wikipedia.org/wiki/Bitset"><strong>BitSet</strong></a> class.
We assume, that in the majority of cases, the bitset will be empty. So as an optimization we want to provide a special
<strong>EmptyBitSet</strong> class, to conserve space. Otherwise</p>

<p>We also want to have a mutable variant <strong>MutableBitSet</strong>, that is a subclass of <strong>BitSet</strong> (and not the other way around,
like in Apple Foundation).</p>

<h2 id="the-base-class">The base class</h2>

<p>This is the “user” facing class. All other classes will be more or less hidden. This class defines the API.
It also adopts the mulle-objcClassCluster protocolclass.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">BitSet</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span> <span class="n">MulleObjCClassCluster</span><span class="o">&gt;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithBits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
                        <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// methods to be implemented by classcluster classes</span>
<span class="k">@interface</span> <span class="nc">BitSet</span><span class="p">(</span> <span class="nl">ClassCluster</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>The implementation now either produces an <strong>EmptyBitSet</strong> or a <strong>ConcreteBitSet</strong>, depending on all input
bits being clear or not:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "BitSet.h"
</span>
<span class="k">@implementation</span> <span class="nc">BitSet</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
    <span class="k">return</span><span class="p">(</span> <span class="p">[[</span><span class="n">EmptyBitSet</span> <span class="nf">sharedInstance</span><span class="p">]</span> <span class="nf">retain</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithBits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
                        <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
   <span class="n">NSUInteger</span>   <span class="o">*</span><span class="n">p</span><span class="p">;</span>
   <span class="n">NSUInteger</span>   <span class="o">*</span><span class="n">sentinel</span><span class="p">;</span>

   <span class="n">p</span>        <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
   <span class="n">sentinel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span> <span class="nf">count</span><span class="p">];</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">sentinel</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
         <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">ConcreteBitset</span> <span class="nf">newWithBits</span><span class="p">:</span><span class="n">bits</span>
                                       <span class="nl">count:</span><span class="n">count</span><span class="p">]);</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[[</span><span class="n">EmptyBitSet</span> <span class="nf">sharedInstance</span><span class="p">]</span> <span class="nf">retain</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<h4 id="some-notes-on-the-implementation">Some notes on the implementation.</h4>

<p>As we are implementing a classcluster, we know that the <code class="language-plaintext highlighter-rouge">-initWithBits:count:</code>
method is operating on a special kind of object, the placeholder. A placeholder
is a constant instance of <strong>BitSet</strong> in our case. A constant instance ignores
all <code class="language-plaintext highlighter-rouge">-retain</code>/<code class="language-plaintext highlighter-rouge">-release</code> calls, so we do not need to <code class="language-plaintext highlighter-rouge">-[self release]</code> in
<code class="language-plaintext highlighter-rouge">-initWithBits:count:</code> to avoid leaks.</p>

<p>We are using a shared instance for <strong>EmptyBitSet</strong> to reduce the footprint of
the application. Only one instance of this immutable bitset will be generated.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> </div>

<h2 id="the-concrete-classes">The concrete classes</h2>

<p>The <strong>EmptyBitSet</strong> is very simple, as the instance creation is done with +
<code class="language-plaintext highlighter-rouge">+sharedInstance</code> provided by <code class="language-plaintext highlighter-rouge">MulleObjCSingleton</code> already:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "BitSet.h"
</span>
<span class="k">@interface</span> <span class="nc">EmptyBitSet</span> <span class="p">:</span> <span class="nc">BitSet</span> <span class="o">&lt;</span><span class="n">MulleObjCSingleton</span><span class="o">&gt;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "EmptyBitSet.h"
</span>
<span class="k">@implementation</span> <span class="nc">EmptyBitSet</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span>
<span class="p">{</span>
    <span class="k">return</span><span class="p">(</span> <span class="nb">NO</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "BitSet.h"
</span>
<span class="k">@interface</span> <span class="nc">ConcreteBitSet</span> <span class="p">:</span> <span class="nc">BitSet</span>
<span class="p">{</span>
    <span class="n">NSUInteger</span>   <span class="o">*</span><span class="n">_bits</span><span class="p">;</span>
    <span class="n">NSUInteger</span>   <span class="n">_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>In the case of <strong>ConcreteBitSet</strong> we need to be aware that we are subclassing
the placeholder class <strong>BitSet</strong>. So <code class="language-plaintext highlighter-rouge">+alloc</code> will just produce the same
placeholder object that ‘self’ already is. We therefore need to implement the
instance creation and deallocation with primitive runtime functions ourselves:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "ConcreteBitSet.h"
</span>
<span class="k">@implementation</span> <span class="nc">ConcreteBitSet</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">newWithBits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
             <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
    <span class="n">ConcreteBitSet</span>  <span class="o">*</span><span class="n">set</span><span class="p">;</span>
    <span class="kt">size_t</span>          <span class="n">size</span><span class="p">;</span>

    <span class="n">set</span>         <span class="o">=</span> <span class="n">NSAllocateObject</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">size</span>        <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">NSUInteger</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
    <span class="n">set</span><span class="o">-&gt;</span><span class="n">_bits</span>  <span class="o">=</span> <span class="n">mulle</span><span class="o">-</span><span class="n">objcObjectAllocateNonZeroedMemory</span><span class="p">(</span> <span class="n">set</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">set</span><span class="o">-&gt;</span><span class="n">_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">_bits</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dealloc</span>
<span class="p">{</span>
   <span class="n">MulleObjCObjectDeallocateMemory</span><span class="p">(</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_bits</span><span class="p">);</span>
   <span class="n">NSDeallocateObject</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span>
<span class="p">{</span>
   <span class="n">NSUInteger</span>  <span class="n">i</span><span class="p">;</span>
   <span class="n">NSUInteger</span>  <span class="n">bit</span><span class="p">;</span>

   <span class="n">i</span>   <span class="o">=</span> <span class="n">index</span> <span class="o">/</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span> <span class="n">NSUInteger</span><span class="p">)</span> <span class="o">*</span> <span class="n">CHAR_BIT</span><span class="p">);</span>
   <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span> <span class="n">NSUInteger</span><span class="p">)</span> <span class="o">*</span> <span class="n">CHAR_BIT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">_count</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span> <span class="nb">NO</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">_bits</span><span class="p">[</span> <span class="nf">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bit</span> <span class="p">?</span> <span class="nb">YES</span> <span class="p">:</span> <span class="nb">NO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<h2 id="adding-a-class-to-a-classcluster">Adding a class to a classcluster</h2>

<p>You chance upon the <a href="https://github.com/CountOnes/hamming_weight">CountOnes</a>
project and its AVX2 implementation and would like to  support it with
a class <code class="language-plaintext highlighter-rouge">ConcreteAVX2Bitset</code> for larger bitsets, when AVX2 is available.</p>

<p>You could then expand the current init method in <strong>BitSet</strong>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithBits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
                        <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
   <span class="n">NSUInteger</span>   <span class="o">*</span><span class="n">p</span><span class="p">;</span>
   <span class="n">NSUInteger</span>   <span class="o">*</span><span class="n">sentinel</span><span class="p">;</span>

   <span class="n">p</span>        <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
   <span class="n">sentinel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span> <span class="nf">count</span><span class="p">];</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">sentinel</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
             <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">ConcreteAVX2Bitset</span> <span class="nf">newWithBits</span><span class="p">:</span><span class="n">bits</span>
                                               <span class="nl">count:</span><span class="n">count</span><span class="p">]);</span>
         <span class="k">else</span>
             <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">ConcreteBitset</span> <span class="nf">newWithBits</span><span class="p">:</span><span class="n">bits</span>
                                           <span class="nl">count:</span><span class="n">count</span><span class="p">]);</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[[</span><span class="n">EmptyBitSet</span> <span class="nf">sharedInstance</span><span class="p">]</span> <span class="nf">retain</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Or you could add a new <code class="language-plaintext highlighter-rouge">-initWithAVX2Bits:count:</code> method. The advantage of using another <code class="language-plaintext highlighter-rouge">-init</code>
methods is, that you can add it to your classcluster using a category:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">BitSet</span><span class="p">(</span> <span class="nl">ConcreteAVX2Bitset</span><span class="p">)</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithAVX2Bits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
                            <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">ConcreteAVX2Bitset</span> <span class="nf">newWithBits</span><span class="p">:</span><span class="n">bits</span>
                                     <span class="nl">count:</span><span class="n">count</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="subclassing-a-classcluster">Subclassing a classcluster</h2>

<p>The main obstacle to subclassing a classcluster is the reimplementation of the
instance allocation methods. You should reimplement the following methods in
your subclass:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">alloc</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">NSAllocateObject</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">allocWithZone</span><span class="p">:(</span><span class="n">NSZone</span> <span class="o">*</span><span class="p">)</span> <span class="n">zone</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">NSAllocateObject</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">new</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">NSAllocateObject</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="nf">init</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now your subclass and its subclass will create instances of the proper class.
But you will also need to override the init functions of the classcluster. In
the case of <strong>BitSet</strong> there is only one <code class="language-plaintext highlighter-rouge">-initWithBits:count:</code>, which makes
this easy.</p>

<h2 id="classcluster-on-top-of-classcluster">Classcluster on top of classcluster</h2>

<p>It’s entirely possible to create a classcluster on top of another classcluster,
as we will show with <strong>MutableBitSet</strong>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "BitSet.h"
</span>
<span class="k">@interface</span> <span class="nc">MutableBitSet</span> <span class="p">:</span> <span class="nc">BitSet</span> <span class="o">&lt;</span><span class="n">MulleObjCClassCluster</span><span class="o">&gt;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">setBool</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span> <span class="n">flag</span>
         <span class="n">atIndex</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span> <span class="nf">boolAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">index</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>The main thing we will have to override is the init method, as we will have to
use different classes. Because I am extremely lazy, I will restrict the code to
just one class:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "MutableBitSet.h"
</span>
<span class="k">@implementation</span> <span class="nc">MutableBitSet</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithBits</span><span class="p">:(</span><span class="n">NSUInteger</span> <span class="o">*</span><span class="p">)</span> <span class="n">bits</span>
                        <span class="n">count</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">count</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">ConcreteMutableBitset</span> <span class="nf">newWithBits</span><span class="p">:</span><span class="n">bits</span>
                                        <span class="nl">count:</span><span class="n">count</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: Singleton classes</h1>
             <h2 id="create-a-singleton-class">Create a Singleton class</h2>

<p>To create a
<a href="http://www.galloway.me.uk/tutorials/singleton-classes/">singleton class</a> that
instantiates via <code class="language-plaintext highlighter-rouge">+sharedInstance</code>, you merely adopt the <strong>MulleObjCSingleton</strong>
protocol and you are done.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span> <span class="n">MulleObjCSingleton</span><span class="o">&gt;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>That’s because <strong>MulleObjCSingleton</strong> is a <a href="protocolclass.html">protocolclass</a>.</p>

<p>If you subclass a singleton class, your subclass should also adopt
<strong>MulleObjCSingleton</strong>. Now your class will create a new shared instance.
Otherwise your subclass would be ignored by <code class="language-plaintext highlighter-rouge">sharedInstance</code>. Your subclass
singleton will now coexist with the base class singleton.</p>

<h2 id="modifications">Modifications</h2>

<h3 id="change-name-of-the-initializer">Change name of the initializer</h3>

<p>If you want to use a different name than <code class="language-plaintext highlighter-rouge">+sharedInstance</code> add this to your
class:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">myInit</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">MulleObjCSingletonCreate</span><span class="p">(</span> <span class="n">self</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="init-the-singleton-differently">Init the singleton differently</h3>

<p>Usually the singleton will be allocated with <code class="language-plaintext highlighter-rouge">-init</code>. You can override <code class="language-plaintext highlighter-rouge">-init</code>
for the singleton instance with <code class="language-plaintext highlighter-rouge">-__initSingleton</code>.
This could be useful, if your singleton needs a special setup and you have a
not-so-true singleton class like <strong>NSNotificationCenter</strong>, which can
instantiate other instances.</p>

<h3 id="prevent-other-instances-of-the-same-class">Prevent other instances of the same class</h3>

<p>“Poison” the <code class="language-plaintext highlighter-rouge">-init</code> method by returning the singleton instead. Initialize the
singleton with <code class="language-plaintext highlighter-rouge">-__initSingleton</code>.
As a result you can now expect to be able to use pointer equality for
<code class="language-plaintext highlighter-rouge">-isEqual:</code> comparisons.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
   <span class="n">Class</span>   <span class="n">cls</span><span class="p">;</span>

   <span class="n">cls</span> <span class="o">=</span> <span class="n">MulleObjCInstanceGetClass</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
   <span class="p">[</span><span class="n">self</span> <span class="nf">release</span><span class="p">];</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">MulleObjCSingletonCreate</span><span class="p">(</span> <span class="n">cls</span><span class="p">)</span> <span class="nf">retain</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">__initSingleton</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="technical-considerations">Technical considerations</h2>

<h3 id="infinitely-retained">Infinitely retained</h3>

<p>A singleton is infinitely retained. If you know you are dealing with a
singleton, you do not have to retain or release this. It isn’t really
recommended to exploit this, as it makes the code more brittle.</p>

<h3 id="thread-safety">Thread safety</h3>

<p>The actual creation of the singleton instance is thread safe, there are no
duplicate instances in multiple threads.</p>

<h3 id="testing">Testing</h3>

<p>Usually singletons aren’t releases. Under a test environment, the
<a href="protocolclass.html">universe</a> will be shutdown in an orderly fashion
and your singleton will be release.</p>

<p>If you want to leak-check within the test though, the singleton will appear as
a leak. To circumvent this you can set the environment variable
<code class="language-plaintext highlighter-rouge">MULLE_OBJC_EPHEMERAL_SINGLETON</code> to YES. The singleton will be now be created
in a thread-unsafe manner and will only last as long as the enclosing
<strong>NSAutoreleasePool</strong>.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Advanced: Tagged Pointer Classes</h1>
             <div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> If you are using the <strong>MulleFoundation</strong>, then
tagged pointers will be used for <strong>NSNumber</strong> and <strong>NSString</strong> leaving little
(64 bit) or no (32 bit) room for own tagged pointer classes.</div>

<h2 id="create-a-tagged-pointer-tps-class">Create a tagged pointer (TPS) class</h2>

<p>A tagged pointer class is great, if you have a lot of instances that are
extremely small. Let’s say you want to encode a 24 bit color in a tagged
pointer, here’s how to do it.</p>

<h3 id="choose-a-free-index">Choose a free index</h3>

<p>On 32 bit you have 1-3 available, on 64 bit it is 1-7. You can use this function
to search for a free index:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span> <span class="o">=</span>  <span class="n">mulle_objc_universe_search_free_taggedpointerclass</span><span class="p">(</span> <span class="n">universe</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">i</span><span class="p">)</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">i</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="let-the-tps-class-inherit-your-class">Let the TPS class inherit your class</h3>

<p>Subclass your color class and adorn your <code class="language-plaintext highlighter-rouge">@interface</code> declaration with the
<code class="language-plaintext highlighter-rouge">MulleObjCTaggedPointer</code> protocol:
Your class must be abstract and not contain any instance variables.
Use <code class="language-plaintext highlighter-rouge">#ifdef __MULLE_OBJC_TPS__</code> around your code, as the user can turn off TPS
code with a compiler option. Your code should run fine without TPS enabled
(just don’t use the TPS class then).</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __MULLE_OBJC_TPS__
</span>
<span class="k">@interface</span> <span class="nc">MyTPSColor</span> <span class="p">:</span> <span class="nc">MyColor</span> <span class="o">&lt;</span><span class="n">MulleObjCTaggedPointer</span><span class="o">&gt;</span>
<span class="k">@end</span>

<span class="cp">#endif
</span></code></pre></div></div>

<h3 id="create-a-load-method">Create a +load method</h3>

<p>This will hookup your class into the TPS system at runtime. It’s assumed you
are using a fixed number scheme here and the TPS index chosen is ‘3’.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __MULLE_OBJC_TPS__
</span>
<span class="k">@implementation</span> <span class="nc">MyTPSColor</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">load</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">MulleObjCTaggedPointerRegisterClassAtIndex</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">))</span>
   <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span> <span class="s">"Need tag pointer aware runtime for MyTPSColor with empty slot #3</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">abort</span><span class="p">();</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="cp">#endif
</span></code></pre></div></div>

<h3 id="create-tps-instance-depending-on-input">Create TPS instance depending on input</h3>

<p>Convert you color to a 24 bit value and create the instance with the <code class="language-plaintext highlighter-rouge">C</code> function
<code class="language-plaintext highlighter-rouge">MulleObjCCreateTaggedPointerWithUnsignedIntegerValueAndIndex</code>. Do not use <code class="language-plaintext highlighter-rouge">+alloc</code>!</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="n">MyColor</span>   <span class="o">*</span><span class="nf">TPSColorNew</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span> <span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">NSUInteger</span>   <span class="n">value</span><span class="p">;</span>

   <span class="n">value</span> <span class="o">=</span> <span class="p">(((</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">b</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">(</span><span class="n">MyColor</span> <span class="o">*</span><span class="p">)</span> <span class="n">MulleObjCCreateTaggedPointerWithUnsignedIntegerValueAndIndex</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="retrieve-value-from-tps-instance">Retrieve value from TPS instance</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">MyTPSColor</span>

<span class="p">...</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">getRedComponent</span>
<span class="p">{</span>
   <span class="n">NSUInteger</span>   <span class="n">value</span><span class="p">;</span>

   <span class="n">value</span> <span class="o">=</span> <span class="n">MulleObjCTaggedPointerGetUnsignedIntegerValue</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And that’s about it.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Differences to Objective-C 2.0</h1>
             <p>In terms of language features, <strong>mulle_objc</strong> resets the basis of Objective-C
back to ObjC 1.0 and cherrypicks improvements from the later versions.</p>

<h2 id="differences-to-objective-c-20">Differences to Objective-C 2.0</h2>

<p>Do not use the “not planned” features even if the <strong>mulle-objc</strong> compiler might
still understand them. The runtime or the linker will not support them.</p>

<table>
  <thead>
    <tr>
      <th>Topic</th>
      <th>State</th>
      <th>Link</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>@encode()</strong></td>
      <td>supported: 90% the same as the Apple runtime</td>
      <td>([what is this ?](https://nshipster.com/</td>
      <td>type-encodings/))</td>
    </tr>
    <tr>
      <td><strong>@package</strong></td>
      <td>never: will produce an error</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>@synchronized()</strong></td>
      <td>not planned</td>
      <td>(<a href="https://rykap.com/objective-c/2015/05/09/synchronized/">what is this ?</a>)</td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>^</strong>blocks</td>
      <td>not planned: [^3]</td>
      <td>([what is this ?](https://medium.com/@amyjoscelyn/</td>
      <td>blocks-and-closures-in-objective-c-2b763e9e0dc8))</td>
    </tr>
    <tr>
      <td><strong>atomic</strong></td>
      <td>not planned: <strong>atomic</strong> as default: never</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>BOOL</strong></td>
      <td>supported: but it is an <code class="language-plaintext highlighter-rouge">int</code>. If you really need to use <code class="language-plaintext highlighter-rouge">bool</code> use <code class="language-plaintext highlighter-rouge">_Bool</code>.</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>@import</strong></td>
      <td>not planned</td>
      <td>([what is this ?](https://stoneofarc.wordpress.com/2013/06/25/</td>
      <td>introduction-to-objective-c-modules/))</td>
    </tr>
    <tr>
      <td><strong>nullable</strong></td>
      <td>not planned: will produce an error [^2]</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>readonly</strong></td>
      <td>supported: but an ivar will be synthesized</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>weak</strong>, <strong>strong</strong></td>
      <td>never</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">__bridge</code></td>
      <td>will be a nop #define (also <code class="language-plaintext highlighter-rouge">__bridge_retained</code>, <code class="language-plaintext highlighter-rouge">__bridge_transfer</code>)</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">__unsafe_unretained</code></td>
      <td>could be a nop #define  (<code class="language-plaintext highlighter-rouge">_autoreleasing</code>)</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>ARC</td>
      <td>never: but look for mulle-objc’s AAM</td>
      <td>([what is this ?](https://www.yorkhua.com/</td>
      <td>objective-c-arc/))</td>
    </tr>
    <tr>
      <td><strong>@implementation()</strong></td>
      <td>never: class extension with added instance variables don’t work</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>NSArray&lt;NSString* &gt;</strong></td>
      <td>never: generics are not in the cards</td>
      <td>([what is this ?](https://www.thomashanning.com/</td>
      <td>objective-c-lightweight-generics/)</td>
    </tr>
    <tr>
      <td>ObjectiveC++</td>
      <td>never: But the mulle-objc instance memory layout should be <code class="language-plaintext highlighter-rouge">this-&gt;__vtab</code> compatible to</td>
      <td>allow dual facing objects.</td>
      <td> </td>
    </tr>
    <tr>
      <td>NSArray *foo; foo[ 1]</td>
      <td>not planned: [^1] what is known as “Subscripting”</td>
      <td>([what is this ?](https://nshipster.com/</td>
      <td>object-subscripting/))</td>
    </tr>
    <tr>
      <td>Non-fragile ivars</td>
      <td>never</td>
      <td>([what is this ?](https://www.sealiesoftware.com/blog/archive/2009/01/27/</td>
      <td>objc_explain_Non-fragile_ivars.html))</td>
    </tr>
    <tr>
      <td>property dot syntax</td>
      <td>not planned: [^1]</td>
      <td>([what is this ?](https://stackoverflow.com/questions/7423853/</td>
      <td>whats-the-difference-between-dot-syntax-and-square-bracket-syntax))</td>
    </tr>
    <tr>
      <td>Protocol</td>
      <td>never: <code class="language-plaintext highlighter-rouge">Protocol</code> as a class is gone. You have to use <code class="language-plaintext highlighter-rouge">PROTOCOL</code> instead of <code class="language-plaintext highlighter-rouge">Protocol *</code></td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>variadic arguments (:…)</td>
      <td>supported: but not compatible to <code class="language-plaintext highlighter-rouge">&lt;stdarg.h&gt;</code></td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>Topic</th>
      <th>State</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NSLog</code></td>
      <td>generally not used anymore, use <code class="language-plaintext highlighter-rouge">mulle-printf</code> instead</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<hr />
<h3 id="appendix">Appendix</h3>

<h4 id="footnotes">Footnotes</h4>

<p>[^1] : This is basically operator overloading, which is un-C like.</p>

<p>[^2] : Superflous keyword, ObjC is by design nullable. It only makes sense to
adorn non-nullable parameters.</p>

<p>[^3] : GCD is a Apple technology, that really needs kernel support to work well. lambdas are not a part of C11. Generally I find blocks unconvincing. It might be an idea to make <code class="language-plaintext highlighter-rouge">NSInvocation</code>s  out of block syntax ?</p>

<h4 id="glossary">Glossary</h4>

<table>
  <thead>
    <tr>
      <th>Wording</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>not supported</td>
      <td>might just accidentally work</td>
    </tr>
    <tr>
      <td>not planned</td>
      <td>never say never, but this probably won’t happen</td>
    </tr>
    <tr>
      <td>never</td>
      <td>sometimes you have to say never :)</td>
    </tr>
  </tbody>
</table>

<h4 id="terminology">Terminology</h4>

<p>For the discussed concepts and terminology check any of the following links.</p>

<ol>
  <li><a href="https://en.wikipedia.org/wiki/Objective-C#Objective-C_2.0">Wikipedia: Objective-C</a></li>
  <li><a href="https://developer.apple.com/library/prerelease/ios/releasenotes/ObjectiveC/ObjCAvailabilityIndex/index.html">Apple: Objective-C Feature Availability Index</a></li>
  <li><a href="http://nshipster.com/at-compiler-directives">NSHipster: @compiler directives</a></li>
</ol>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Legacy Workflow</h1>
             <h3 id="modern-workflow">Modern Workflow</h3>

<p>The modern workflow is static library based, which gives the following
advantages over shared libraries:</p>

<ul>
  <li>static linking works on platforms that do not support dynamic libraries</li>
  <li>static linking can be optimized to remove unused classes and categories</li>
  <li>static linking produces executables that are easier to install and deploy</li>
</ul>

<p>In contrast, the legacy workflow is shared library based.</p>

<p>The advantages of that approach are:</p>

<ul>
  <li>does not require mulle-sde for generating the link order</li>
  <li>does not require cmake</li>
  <li>fewer libraries to link</li>
</ul>

<blockquote>
  <p>Technically you can also do legacy workflow with static libraries. But
it can be a pain in the ass to link the multitude of static libraries in
the correct order, with the correct linker flags in a cross-platform manner.</p>
</blockquote>

<h2 id="legacy-workflow">Legacy workflow</h2>

<p>The legacy workflow installs the <strong>mulle-objc</strong> Foundation as a <em>shared</em> library.
You use the custom compiler <strong>mulle-clang</strong> to compile Objective-C files.
These are then liked with the <code class="language-plaintext highlighter-rouge">Foundation</code> shared library and some startup
libraries.</p>

<p>You can use <strong>make</strong> or most IDEs with this setup.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> The “modern workflow” uses static libraries.</div>

<h3 id="install-a-shared-mullefoundation-library">Install a shared MulleFoundation library</h3>

<p>Use <strong>mulle-sde</strong> to download all required components of the Foundation
library and to build them. There will be an error, because it can not find an
optional component <strong>MulleObjCDecimalFoundation</strong>. This is harmless.</p>

<p>You can change the install location with the <code class="language-plaintext highlighter-rouge">--prefix</code> option. Otherwise
the <code class="language-plaintext highlighter-rouge">usr</code> directory of your home directory, will be the install destination.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">mulle-sde install --standalone --prefix "$</span><span class="o">{</span>HOME<span class="o">}</span>/usr<span class="s2">" "</span>https://github.com/MulleFoundation/Foundation/archive/latest.zip<span class="s2">"
</span></code></pre></div></div>

<p>A shared (dynamic) <code class="language-plaintext highlighter-rouge">libFoundation</code> library and some other static libraries
should be present in your <code class="language-plaintext highlighter-rouge">~/usr/lib</code> folder now.</p>

<blockquote>
  <p>If you have the repositories already checked out,
you can prefix the command with a search path, to avoid downloads
e.g.</p>

  <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SRCROOT</span><span class="o">=</span><span class="s2">"/Volumes/Source/srcO"</span> <span class="p">;</span> <span class="se">\</span>
<span class="nv">MULLE_FETCH_SEARCH_PATH</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/MulleFoundation:</span><span class="se">\</span><span class="s2">
</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/MulleWeb:</span><span class="se">\</span><span class="s2">
</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/mulle-objc:</span><span class="se">\</span><span class="s2">
</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/mulle-core:</span><span class="se">\</span><span class="s2">
</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/mulle-concurrent:</span><span class="se">\</span><span class="s2">
</span><span class="k">${</span><span class="nv">SRCROOT</span><span class="k">}</span><span class="s2">/mulle-c"</span> mulle-sde <span class="nb">install</span> ...
</code></pre></div>  </div>
</blockquote>

<h3 id="build-and-install-foundation-startup">Build and install Foundation-startup</h3>

<p>The Foundation-startup must be built and installed separately.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mulle-sde install --only-project --prefix "${HOME}/usr" "https://github.com/MulleFoundation/Foundation-startup/archive/latest.zip"
</code></pre></div></div>

<p>This duplicates much of the work already done by the previous Foundation
built, but this can not be avoided easily.</p>

<h2 id="usage">Usage</h2>

<h3 id="write-hello-world">Write Hello World</h3>

<p>Lets create the canonical hello world program:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt;EOF &gt; hello-world.m
#import &lt;Foundation/Foundation.h&gt;

int   main( int argc, char *argv[])
{
   NSLog( @"Hello World");
   return( 0);
}
EOF
</code></pre></div></div>

<h3 id="build-hello-world">Build Hello World</h3>

<p>Building is now platform specific (unless you use <strong>cmake</strong>). You must use
<strong>mulle-clang</strong> to compile the source:</p>

<h4 id="linux">Linux:</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mulle-clang hello-world.m \
            -o hello-world \
            -isystem "${HOME}/usr/include" \
            -L"${HOME}/usr/lib" \
            -Wl,-rpath -Wl,"${HOME}/usr/lib" \
            -lFoundation \
            -Wl,--whole-archive \
            -lFoundation-startup \
            -lmulle-atinit \
            -lmulle-atexit \
            -Wl,--no-whole-archive \
            -lpthread \
            -ldl \
            -lm
</code></pre></div></div>

<h4 id="macos">macOS:</h4>

<p>On macOS we need to use Xcode platform headers and therefore need the SDK
path, which can vary for each host. It is assumed you used the <strong>brew</strong>
install method, otherwise you need to correct the <code class="language-plaintext highlighter-rouge">-isystem</code>, <code class="language-plaintext highlighter-rouge">-L</code>, <code class="language-plaintext highlighter-rouge">-rpath</code>
values in the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>XCODE_SDK_DIR="`xcrun --show-sdk-path`"
mulle-clang  hello-world.m \
            -o hello-world \\
            -isystem "/usr/local/include" \
            -isystem "${XCODE_SDK_DIR}/include" \
            -L"/usr/local/lib" \
            -Wl,-rpath -Wl,"/usr/local/lib" \
            -lFoundation \
            -Wl,-all_load \
            -lFoundation-startup \
            -lmulle_atinit \
            -lmulle_atexit
            -Wl,-noall_load
</code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> You can also use Xcode to build mulle-objc
code. See <a href="//github.com/mulle-objc/mulle-objc-developer/wiki/Xcode-integration">Xcode integration</a> for setup instructions.</div>

<h2 id="run-hello-world">Run Hello World</h2>

<p>And run your first mulle-objc executable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./hello-world
</code></pre></div></div>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Bad mulle-objc Code</h1>
             <h2 id="bad-code">Bad Code</h2>

<p>These are examples of Objective-C 2.0 code, that will not work with mulle-objc.</p>

<h3 id="import">@import</h3>

<p>mulle-objc has no support for modules and the <strong>@import</strong> directive. This will
give a compiler error:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@import</span> <span class="n">Whatever</span><span class="p">;</span>             <span class="c1">// @import doesn't work</span>
</code></pre></div></div>

<p>See <a href="modules.html">Porting @import</a> for code conversion tips.</p>

<h3 id="unsupported-property-attributes">Unsupported @property attributes</h3>

<p>The attributes <strong>atomic</strong>,<strong>weak</strong>,<strong>strong</strong>,<strong>nullable</strong>,<strong>unsafe_retained</strong>
<strong>class</strong> are all unknown to mulle-objc and will produce errors:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">Foo</span>

<span class="c1">// unsupported property attribute</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">atomic</span><span class="p">)</span> <span class="n">id</span>  <span class="n">a</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">weak</span><span class="p">)</span> <span class="n">id</span>  <span class="n">b</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">strong</span><span class="p">)</span> <span class="n">id</span>  <span class="n">c</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">nullable</span><span class="p">)</span> <span class="n">id</span>  <span class="n">d</span><span class="p">;</span>      <span class="c1">// nullable can be #defined away without trouble</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">unsafe_unretained</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span> <span class="c1">// shpuld be no different to assign though</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">class</span><span class="p">)</span> <span class="n">id</span>  <span class="n">f</span><span class="p">;</span>         <span class="c1">// class has a chance of being supported sometime</span>

</code></pre></div></div>

<p>See <a href="property.html">Porting @property</a> for conversion tips.</p>

<h3 id="synthesize-with-different-ivar-name">@synthesize with different ivar name</h3>

<p>You can not synthesize to a different name, ivar must be <code class="language-plaintext highlighter-rouge">'_'&lt;name&gt;</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// continuing the interface declaration...</span>
<span class="c1">// we need the next two declarations for @synthesize to complain</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">assign</span><span class="p">)</span> <span class="n">id</span> <span class="n">g</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span> <span class="n">assign</span><span class="p">)</span> <span class="n">id</span> <span class="n">h</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="k">@synthesize</span> <span class="n">g</span> <span class="o">=</span> <span class="n">_g1</span><span class="p">;</span>

<span class="c1">// specfiying a property as dynamic with @dynamic does nothing in mulle-objc</span>
<span class="k">@dynamic</span> <span class="n">h</span><span class="p">;</span>
</code></pre></div></div>

<p>See <a href="synthesize.html">Porting @synthesize</a> for code conversion tips.</p>

<h3 id="subscripting">Subscripting</h3>

<p>Subscripting for <code class="language-plaintext highlighter-rouge">NSArray</code> and <code class="language-plaintext highlighter-rouge">NSDictionary</code> or any other class is not
supported. Instead the compiler will use C indexing:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// subscripting is not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">getFirst</span><span class="p">:(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span> <span class="n">array</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span> <span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="subscripting.html">Porting Subscripting</a> for code conversion tips.</p>

<h3 id="arc">ARC</h3>

<p>ARC code will crash or leak depending on what you are doing:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">ARC</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[[</span><span class="n">NSArray</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="arc.html">Porting ARC code</a> for code conversion tips.</p>

<h3 id="dot-syntax">Dot syntax</h3>

<p>There is no operator overloading ‘.’ in mulle-objc. ‘.’ is used to accessed
struct and union fields, not objects:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// dotsyntax is not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dotsyntax</span>
<span class="p">{</span>
   <span class="n">self</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="s">@"x"</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>See <a href="dotsyntax.html">Porting Dot Syntax</a> for code conversion tips.</p>

<h3 id="generics">Generics</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// generics are not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">generics</span><span class="p">:(</span><span class="n">NSArray</span><span class="o">&lt;</span><span class="n">NSString</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span> <span class="n">array</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="generics.html">Porting Generics</a> for code conversion tips.</p>

<h3 id="block">Block</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// blocks are not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">blocks</span><span class="p">:(</span><span class="kt">int</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">))</span> <span class="n">aBlock</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="blocks.html">Porting Blocks</a> for code conversion tips.</p>

<h3 id="synchronized">@synchronized</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// synchronized is not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">synchronized</span>
<span class="p">{</span>
   <span class="k">@synchronized</span><span class="p">(</span> <span class="n">self</span><span class="p">)</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="synchronized.html">Porting @synchronized</a> for code conversion tips.</p>

<h3 id="yes-">@YES …</h3>

<p><strong>@YES</strong> and <strong>@NO</strong> are not supported, use <code class="language-plaintext highlighter-rouge">@(YES)</code>,<code class="language-plaintext highlighter-rouge">@(NO)</code> or <code class="language-plaintext highlighter-rouge">+numberWithBool:</code> instead</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// literal BOOL is not supported</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span> <span class="n">literalBOOL</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="nb">@YES</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Note there is a good chance that the mulle-clang compiler will forbid the use
of non-numeric constants for boxing. So for example <code class="language-plaintext highlighter-rouge">@INT_MAX</code> may work
currently but it may not in the future.</p>
</blockquote>

<h3 id="protocol-">Protocol *</h3>

<p><code class="language-plaintext highlighter-rouge">Protocol *</code> as such doesn’t exist in mulle-objc. Use PROTOCOL instead:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Protocol * is not supported, use PROTOCOL</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">keepProtocol</span><span class="p">:(</span><span class="n">Protocol</span> <span class="o">*</span><span class="p">)</span> <span class="n">proto</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">proto</span> <span class="nf">retain</span><span class="p">];</span>  <span class="c1">// PROTOCOL is not an object</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="protocol.html">Porting Protocol</a> for code conversion tips.</p>

<h3 id="casting-sel-to-char-">Casting SEL to <code class="language-plaintext highlighter-rouge">(char *)</code></h3>

<p>In the Apple runtime a SEL is basically a string, but this is not true in
mulle-objc:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">printSelectorAsCString</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span> <span class="n">sel</span>
<span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span> <span class="c1">// SEL is not a C-String in mulle-objc</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="accessing-variable-arguments-with-va_list">Accessing variable arguments with va_list</h3>

<p>Variable arguments are NOT <code class="language-plaintext highlighter-rouge">va_list</code> in mulle-objc, but
<a href="//github.com/mulle-c/mulle-vararg">mulle-vararg</a> instead:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">variableArguments</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span><span class="p">,</span> <span class="p">...</span>
<span class="p">{</span>
   <span class="kt">va_list</span>   <span class="n">args</span><span class="p">;</span>

   <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
   <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>See <a href="varargs.html">Porting Varargs</a> for code conversion tips.</p>

<h3 id="package">@package</h3>

<p><strong>@package</strong> is an unsupported keyword.It will produce a compiler error:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">NoWorky</span>
<span class="err">@package</span>
<span class="k">@end</span>
</code></pre></div></div>
<p>See <a href="package.html">Porting Protocol</a> for code conversion tips.</p>

<h2 id="see-the-output-for-yourself">See the output for yourself</h2>

<p>Download (<a href="files/bad-code.m">bad-code.m</a>) and let the compiler tell you
all about it.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: General Tips</h1>
             <h2 id="tips">Tips</h2>

<p>Use the Foundation as your base and not the MulleFoundation, as Foundation also
include <a href="//github.com/mulle-objc/objc-compat">objc-compat</a>.</p>

<h3 id="use-envelope-headers">Use envelope headers</h3>

<p>Rewrite code that imports specific headers to use the envelope header.</p>

<p>Example: Rewrite</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import &lt;Foundation/NSObject.h&gt;
#import &lt;Foundation/NSString.h&gt;
</span></code></pre></div></div>

<p>to</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "import.h" // or &lt;Foundation/Foundation.h&gt; without the modern workflow
</code></pre></div></div>

<p>The exception being <code class="language-plaintext highlighter-rouge">&lt;Foundation/NSDebug.h&gt;</code> or any other header not exposed by
<code class="language-plaintext highlighter-rouge">&lt;Foundation/Foundation.h&gt;</code>.</p>

<h3 id="find-and-correct-uses-of-class_getinstancesize">Find and correct uses of <code class="language-plaintext highlighter-rouge">class_getInstanceSize</code></h3>

<p>Two typical uses for <code class="language-plaintext highlighter-rouge">class_getInstanceSize</code> are</p>

<ol>
  <li>retrieve the amount of memory required to create an instance</li>
  <li>locate the “extra” bytes allocated by <code class="language-plaintext highlighter-rouge">NSAllocateObject</code> at the end of an instance</li>
</ol>

<h4 id="instance-creation">Instance creation</h4>

<p>The number of bytes returned by <code class="language-plaintext highlighter-rouge">class_getInstanceSize</code> is the amount of bytes
required to hold an instance (including mulle-objc runtime overhead).
But the actual object will be at an offset. Pass the allocated memory to
<code class="language-plaintext highlighter-rouge">objc_constructInstance</code> and use the return value as the instance pointer.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">id</span>        <span class="n">obj</span><span class="p">;</span>
<span class="kt">size_t</span>    <span class="n">size</span><span class="p">;</span>
<span class="kt">void</span>      <span class="o">*</span><span class="n">allocation</span><span class="p">;</span>

<span class="n">size</span>       <span class="o">=</span> <span class="n">class_getInstanceSize</span><span class="p">(</span> <span class="n">cls</span><span class="p">);</span>
<span class="n">allocation</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">obj</span>        <span class="o">=</span> <span class="n">objc_constructInstance</span><span class="p">(</span> <span class="n">cls</span><span class="p">,</span> <span class="n">allocation</span><span class="p">);</span>
<span class="p">...</span>
<span class="cp">#ifdef __MULLE_OBJC__
</span><span class="n">allocation</span> <span class="o">=</span> <span class="n">object_getAlloc</span><span class="p">(</span> <span class="n">obj</span><span class="p">);</span>
<span class="cp">#else
</span><span class="n">allocation</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="n">free</span><span class="p">(</span> <span class="n">allocation</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="access-extra-bytes">Access extra bytes</h4>

<p>Remember that your class may be subclassed. An offset from the last known instance variable
in your class implementation may not be correct.</p>

<p>The proper and portable way to get a pointer to the extra bytes is:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span>    <span class="n">size</span><span class="p">;</span>
<span class="kt">void</span>      <span class="o">*</span><span class="n">allocation</span><span class="p">;</span>
<span class="kt">void</span>      <span class="o">*</span><span class="n">extra</span><span class="p">;</span>

<span class="n">size</span>       <span class="o">=</span> <span class="n">class_getInstanceSize</span><span class="p">(</span> <span class="n">object_getClass</span><span class="p">(</span> <span class="n">self</span><span class="p">));</span>
<span class="cp">#ifdef __MULLE_OBJC__
</span><span class="n">allocation</span> <span class="o">=</span> <span class="n">object_getAlloc</span><span class="p">(</span> <span class="n">obj</span><span class="p">);</span>
<span class="cp">#else
</span><span class="n">allocation</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="n">extra</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">allocation</span><span class="p">)[</span> <span class="nf">size</span><span class="p">];</span>
</code></pre></div></div>

<p>If you use <a href="https://github.com/MulleFoundation/objc-compat">objc-compat</a>, you
can use <code class="language-plaintext highlighter-rouge">object_getExtraBytes</code>, which does exactly the above.</p>

<h3 id="register-composed-selectors-before-using-messaging">Register composed selectors before using messaging</h3>

<p>If you compose a selector from a C string, you must then use <code class="language-plaintext highlighter-rouge">sel_registerName</code>
to acquire a <code class="language-plaintext highlighter-rouge">SEL</code> from the string. Then use this <code class="language-plaintext highlighter-rouge">SEL</code> for messaging.
(You can also use <code class="language-plaintext highlighter-rouge">NSSelectorFromString</code>)</p>

<h3 id="find-and-correct-uses-of-objc_msgsend-and-objc_msgsend_stret">Find and correct uses of <code class="language-plaintext highlighter-rouge">objc_msgSend</code> and <code class="language-plaintext highlighter-rouge">objc_msgSend_stret</code></h3>

<p>Use the <a href="https://www.mulle-kybernetik.com/weblog/2015/mulle_objc_meta_call_convention.html">mulle-objc MetaABI</a>
convention to pass parameters and inspect return values.</p>

<h3 id="find-and-correct-uses-of-protocol">Find and correct uses of <code class="language-plaintext highlighter-rouge">Protocol</code></h3>

<p><code class="language-plaintext highlighter-rouge">Protocol *</code> does not exist. Replace it with <code class="language-plaintext highlighter-rouge">PROTOCOL</code>. You can not treat
<code class="language-plaintext highlighter-rouge">PROTOCOL</code> as an object and message it.</p>

<h3 id="find-initialize-and-load-methods-and-add-dependency-information">Find <code class="language-plaintext highlighter-rouge">+initialize</code> and <code class="language-plaintext highlighter-rouge">+load</code> methods and add dependency information</h3>

<p>The proper dependencies must be declared, the only known dependency to exist is the runtime during loading and initialization. Everything else must be declared.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MULLE_OBJC_DEPENDS_ON_LIBRARY( Foundation);
</code></pre></div></div>

<h4 id="move-class-extension-code-to-the-interface">Move class extension code to the @interface</h4>

<p>TODO</p>

<h4 id="fix-mismatching-property-and-ivar-names-rename-ivars">Fix mismatching property and ivar names (rename ivars)</h4>

<p>TODO</p>

<h4 id="issues">Issues</h4>

<ul>
  <li>the runtime only knows about protocols that are adopted by a class</li>
  <li>PROTOCOL in mulle-objc is a hash value (like a selector) a different type</li>
  <li>you can not message protocols</li>
</ul>

<h3 id="there-is-no-enveloping-nsautoreleasepool-around-load-in-mulle-objc">There is no enveloping NSAutoreleasePool around <code class="language-plaintext highlighter-rouge">+load</code> in mulle-objc</h3>

<p>If you create ephemeral instances in your <code class="language-plaintext highlighter-rouge">+load</code> method, you should wrap
the code yourself inside an <code class="language-plaintext highlighter-rouge">NSAutoreleasePool</code>.</p>

<h3 id="sizeof-unichar-is-different">sizeof( unichar) is different</h3>

<p>Apple Foundation uses UTF-16 as unichar, whereas the mulle-objc Foundation
uses UTF-32 as unichar. As long as your code is not assuming 16-bit for its
size, there should be no problem.</p>

<p>When accessing string contents as <code class="language-plaintext highlighter-rouge">unichar *</code> with say <code class="language-plaintext highlighter-rouge">-dataUsingEncoding:</code>
use the generic <code class="language-plaintext highlighter-rouge">NSUnicodeStringEncoding</code> instead of <code class="language-plaintext highlighter-rouge">NSUTF32StringEncoding/NSUTF16StringEncoding</code>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="nf">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUnicodeStringEncoding</span><span class="p">];</span>
  <span class="n">here_some_unichars</span><span class="p">(</span> <span class="p">(</span><span class="n">unichar</span> <span class="o">*</span><span class="p">)</span> <span class="p">[</span><span class="n">data</span> <span class="nf">bytes</span><span class="p">],</span> <span class="p">[</span><span class="n">data</span> <span class="nf">length</span><span class="p">]</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">unichar</span><span class="p">));</span>
</code></pre></div></div>
<p>TODO: How about printf with %S ?</p>

<h3 id="inout-">inout …</h3>

<p>These <code class="language-plaintext highlighter-rouge">@encode</code> adornments should still work, but they are not encoded
and decoded:</p>

<ul>
  <li>in</li>
  <li>out</li>
  <li>inout</li>
  <li>bycopy</li>
  <li>byref</li>
  <li>oneway</li>
</ul>

<blockquote>
  <p>See: <a href="https://stackoverflow.com/questions/5609564/objective-c-in-out-inout-byref-byval-and-so-on-what-are-they">Stack Overflow</a></p>
</blockquote>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: subscripting</h1>
             <p>The use of [] to index into an Objective-C array like into a C array is known
as “subscripting”. It will never be supported by <strong>mulle-objc</strong>, because it
introduces an un-C like ambiguity. This also precludes subscripting for
dictionaries.</p>

<h2 id="translate-array-0">Translate array[ 0]</h2>

<p>Use <code class="language-plaintext highlighter-rouge">[array objectAtIndex:0]</code> or the mulle-objc shortcut <code class="language-plaintext highlighter-rouge">[array :0]</code>. The latter
will make your code incompatible with other runtimes though.</p>

<h2 id="translate-dictionary-key">Translate dictionary[ @”key”]</h2>

<p>Use <code class="language-plaintext highlighter-rouge">[dictionary objectForKey:@"key"]</code> or the mulle-objc shortcut <code class="language-plaintext highlighter-rouge">[dictionary :@"key"]</code>.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: ARC</h1>
             <p>ARC as a technology is not available in <strong>mulle-objc</strong> and never will be.</p>

<p>Ideally though, code should remain functional in ARC but work flawlessly in
mulle-objc.</p>

<h2 id="use-convenience-constructors">Use convenience constructors</h2>

<p>Outside of <code class="language-plaintext highlighter-rouge">-init</code> and <code class="language-plaintext highlighter-rouge">-dealloc</code>, replace <code class="language-plaintext highlighter-rouge">[[obj alloc] init]</code> calls with
convenience constructors like <code class="language-plaintext highlighter-rouge">+[NSArray array]</code>, if available.</p>

<h3 id="create-your-own-convenience-constructors">Create your own convenience constructors</h3>

<p>If a convenience constructor is not available, it might be useful to
create your own with a category. Consider this if there is a lot of calls
for the same class/method combination.</p>

<p>This is the code to replace a <code class="language-plaintext highlighter-rouge">[[Foo alloc] initWithRandomNumber]</code> with
<code class="language-plaintext highlighter-rouge">[Foo fooWithRandomNumber]</code>:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">Foo</span><span class="p">(</span> <span class="nl">Convenience</span><span class="p">)</span>

<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">fooWithRandomNumber</span><span class="p">;</span>

<span class="k">@end</span>


<span class="k">@implementation</span> <span class="nc">Foo</span><span class="p">(</span> <span class="nl">Convenience</span><span class="p">)</span>

<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">fooWithRandomNumber</span>
<span class="p">{</span>
   <span class="n">id</span>   <span class="n">obj</span><span class="p">;</span>

   <span class="n">obj</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Foo</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithRandomNumber</span><span class="p">:</span><span class="n">rand</span><span class="p">()];</span>
<span class="cp">#if ! __has_feature(objc_arc)
</span>   <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="nf">autorelease</span><span class="p">];</span>
<span class="cp">#endif
</span>   <span class="k">return</span><span class="p">(</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<h3 id="wrap-allocinit-calls">Wrap alloc/init calls</h3>

<p>You could also use this idea to wrap your <code class="language-plaintext highlighter-rouge">[[obj alloc] init]</code> code</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if __has_feature(objc_arc)
# define AUTORELEASE( x)  x
#else
# define AUTORELEASE( x)  NSAutoreleaseObject( x)
#endif
</span></code></pre></div></div>

<p>So you can simplify the above written <code class="language-plaintext highlighter-rouge">+fooWithRandomNumber</code> like this:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="n">fooWithRandomNumber</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">AUTORELEASE</span><span class="p">(</span> <span class="p">[[</span><span class="n">Foo</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithRandomNumber</span><span class="p">:</span><span class="n">rand</span><span class="p">()]</span> <span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="add-super-dealloc-to--dealloc">Add <code class="language-plaintext highlighter-rouge">[super dealloc]</code> to <code class="language-plaintext highlighter-rouge">-dealloc</code></h3>

<p>You could use this idea to modify your <code class="language-plaintext highlighter-rouge">-dealloc</code> code</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if __has_feature(objc_arc)
# define SUPER_DEALLOC()
#else
# define SUPER_DEALLOC()  [super dealloc]
#endif
</span></code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dealloc</span>
<span class="p">{</span>
   <span class="n">SUPER_DEALLOC</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="fix-convenience-constructors-in--init">Fix convenience constructors in -init</h2>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">init</span>
<span class="p">{</span>
   <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">self</span><span class="p">)</span>
      <span class="n">_foo</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSArray</span> <span class="nf">array</span><span class="p">];</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here an instance variable is initialized with an autoreleased <code class="language-plaintext highlighter-rouge">NSArray</code>, which
will soon be unavailable.</p>

<p>Write <code class="language-plaintext highlighter-rouge">_foo = [[NSArray alloc] init];</code> to make your code ARC and mulle-objc
compatible.</p>

<h2 id="release-instance-variables-manually">Release instance variables manually</h2>

<p>There is often no <code class="language-plaintext highlighter-rouge">-dealloc</code> method in ARC code. That is fine if the
class has only properties. Then mulle-objc will clean up automatically.
If your class has non-property instance variables, they must be released in
<code class="language-plaintext highlighter-rouge">-dealloc</code> or <code class="language-plaintext highlighter-rouge">-finalize</code>.</p>

<p>Since <code class="language-plaintext highlighter-rouge">-finalize</code> isn’t used in ARC code, it can be a good place to do it.
Othewise you could use <code class="language-plaintext highlighter-rouge">#if __has_feature( objc_arc)</code> in <code class="language-plaintext highlighter-rouge">-dealloc</code>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __MULLE_OBJC__
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">finalize</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">_foo</span> <span class="nf">autorelease</span><span class="p">];</span>
   <span class="n">_foo</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

   <span class="p">[</span><span class="n">super</span> <span class="nf">finalize</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>Remember to use <code class="language-plaintext highlighter-rouge">-autorelease</code> instead of <code class="language-plaintext highlighter-rouge">-release</code>. Also <code class="language-plaintext highlighter-rouge">nil</code> out the instance variable in <code class="language-plaintext highlighter-rouge">-finalize</code>.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> You would not nil out in <code class="language-plaintext highlighter-rouge">-dealloc</code> and you
would use <code class="language-plaintext highlighter-rouge">-release</code> in <code class="language-plaintext highlighter-rouge">-dealloc</code>.</div>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: ^blocks</h1>
             <h2 id="disable-blocks">Disable blocks</h2>

<p>A good first step is to wrap all method declarations and definitions with</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __has_extension(blocks)
#endif
</span></code></pre></div></div>

<p>If you are lucky, blocks are just a non-integral,value-added feature
in the ported library.</p>

<h2 id="rewrite">Rewrite</h2>

<p>Generally at this point, you should check <em>how much</em> blocks code there is.
If it is used only a few places, here are some ideas how to convert the code
for mulle-objc.</p>

<h3 id="transform-to-nsinvocation">Transform to NSInvocation</h3>

<p>Blocks that are stored for later execution, are basically a form of
<code class="language-plaintext highlighter-rouge">NSInvocation</code>. Transform your blocks code into a method and create an
<code class="language-plaintext highlighter-rouge">NSInvocation</code> for it.</p>

<h3 id="transform-to-c-function">Transform to C function</h3>

<p>If the block is used immediately, perhaps to map it to an NSArray,
extract the code into a C function. Encapsulate the parameters into a C
struct.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: . syntax for properties</h1>
             <p>Hopefully there will be a code-conversion tool in the future, but for now
translate dot syntax to Objective-C calls.</p>

<p>e.g.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">setup</span>
<span class="p">{</span>
   <span class="n">self</span><span class="p">.</span><span class="n">propertyA</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">self</span><span class="p">.</span><span class="n">propertyB</span><span class="p">.</span><span class="n">numberC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">self</span><span class="p">.</span><span class="n">propertyB</span><span class="p">.</span><span class="n">numberD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">setup</span>
<span class="p">{</span>
   <span class="n">id</span>   <span class="n">propertyB</span><span class="p">;</span>

   <span class="p">[</span><span class="n">self</span> <span class="nf">setPropertyA</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>

   <span class="n">propertyB</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">propertyB</span><span class="p">];</span>
   <span class="p">[</span><span class="n">propertyB</span> <span class="nf">setNumberC</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
   <span class="p">[</span><span class="n">propertyB</span> <span class="nf">setNumberD</span><span class="p">:</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is also better code.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: generics</h1>
             <h2 id="rewrite-by-removing-generics-typing">Rewrite by removing generics typing</h2>

<p>If your parameter is specified as <code class="language-plaintext highlighter-rouge">NSArray&lt;NSNumber *&gt;</code> reduce the type
to <code class="language-plaintext highlighter-rouge">NSArray *</code>.</p>

<h2 id="validate-content-at-runtime">Validate content at runtime</h2>

<p>The way to validate array content in Objective-C is at runtime, when you
are inserting a value:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSParameterAssert</span><span class="p">(</span> <span class="p">[</span><span class="n">obj</span> <span class="nf">isKindOfClass</span><span class="p">:[</span><span class="n">NSNumber</span> <span class="nf">class</span><span class="p">]]);</span>
<span class="p">[</span><span class="n">array</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">obj</span><span class="p">];</span>
</code></pre></div></div>

<h2 id="use-id-for-truely-generic-algorithms">Use <code class="language-plaintext highlighter-rouge">id</code> for truely generic algorithms</h2>

<p>If you want true generic algorithms, consider replacing your type with <code class="language-plaintext highlighter-rouge">id</code>.
You can also then specify the methods your algorithm requires using a
<code class="language-plaintext highlighter-rouge">@protocol</code> and then type your methods with <code class="language-plaintext highlighter-rouge">id &lt;protocol&gt;</code>.
This keeps the algorithm the most resusable.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: @import</h1>
             <p>You will have to use <code class="language-plaintext highlighter-rouge">#import</code> instead.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: @package</h1>
             <p>Replace with <code class="language-plaintext highlighter-rouge">@public</code>.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Protocols are a kind of @selector</h1>
             <p>This will be tricky, but it is a very rare occurence. In Objective-C you
can actually treat a <strong>@protocol</strong> as an object and assign it to <code class="language-plaintext highlighter-rouge">id</code>.
You can not in mulle-objc.</p>

<p>There are no good tips for this yet.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting @property</h1>
             <p>Porting properties in a fashion that works in ARC code and in mulle-objc is
tricky. It is best if you can restrict yourself to <strong>assign</strong>, <strong>copy</strong> and <strong>retain</strong>.</p>

<h2 id="property-deallocation">Property deallocation</h2>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> This is a rare case, where mulle-objc is compatible with ARC, but incompatible with MMR.</div>

<p>In Apple ARC, properties are automatically cleared during <code class="language-plaintext highlighter-rouge">-dealloc</code>. In Apple Manual Retain-Release Mode (MRR)
you have to do it yourself during <code class="language-plaintext highlighter-rouge">-dealloc</code>.</p>

<p>In mulle-objc all properties that reference objects or pointers are cleared during <code class="language-plaintext highlighter-rouge">-finalize</code> by
setting them to <strong>0</strong>.</p>

<p><strong>readonly</strong> properties - they have no setter - are not cleared. But in mulle-objc <em>they are backed by an <strong>ivar</strong></em>.
It is open to discussion if you want to release them in <code class="language-plaintext highlighter-rouge">-dealloc</code> for compatibility or use <code class="language-plaintext highlighter-rouge">-finalize</code> to break
possible retain cycles.</p>

<p>Here is how to write <code class="language-plaintext highlighter-rouge">-dealloc</code> for compatiblity with MMR (also see <a href="arc.html">ARC Porting tips</a>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#if __has_feature(objc_arc) || defined( __MULLE_OBJC__)
# define PROPERTY_RELEASE( p)
#else
# define PROPERTY_RELEASE( p)  [_p release]
#endif
#if __has_feature(objc_arc)
# define SUPER_DEALLOC()
#else
# define SUPER_DEALLOC( p)  [super dealloc]
#endif

- (void) dealloc
{
    PROPERTY_RELEASE( a)
    PROPERTY_RELEASE( b)
    PROPERTY_RELEASE( c)
    SUPER_DEALLOC()
}

</code></pre></div></div>

<h2 id="missing-attributes">Missing Attributes</h2>

<h3 id="atomic">atomic</h3>

<p>Yup it’s gone. Use locking or the atomic operations provided by
<a href="//github.com/mulle-concurrent/mulle-thread">mulle-thread</a>.</p>

<h3 id="weak">weak</h3>

<p>Use <strong>assign</strong> instead.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Use C containers to manage weak references
instead. They won’t <em>magically</em> cleanup though.</div>

<h3 id="strong">strong</h3>

<p>When declaring a property use <strong>copy</strong> or <strong>retain</strong>. You usually
use <strong>copy</strong> for <code class="language-plaintext highlighter-rouge">NSValue</code>, <code class="language-plaintext highlighter-rouge">NSDate</code>, <code class="language-plaintext highlighter-rouge">NSNumber</code> and <code class="language-plaintext highlighter-rouge">NSString</code> arguments,
and <strong>retain</strong> for everything else.</p>

<h3 id="nullable">nullable</h3>

<p>One of the strong points of Objective-C is its gracious handling of
<code class="language-plaintext highlighter-rouge">nil</code> values, which simplifies coding a lot. Remember that messaging <code class="language-plaintext highlighter-rouge">nil</code>
also produces <code class="language-plaintext highlighter-rouge">nil</code>. With the introduction of <code class="language-plaintext highlighter-rouge">nonnull</code> <code class="language-plaintext highlighter-rouge">nullable</code> was
also introduced. It is superflous.</p>

<p>You can easily get rid of <code class="language-plaintext highlighter-rouge">nullable</code> compile errors with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define nullable
</code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Tedious checks for <code class="language-plaintext highlighter-rouge">nil</code> means you are optimizing
your code for the error case. Use <strong>nonnull</strong> sparingly. If a <code class="language-plaintext highlighter-rouge">nil</code> parameter
has no ill effect, don’t mark the code <strong>nonnull</strong>.</div>

<h3 id="unsafe_unretained">unsafe_unretained</h3>

<p>Use <strong>assign</strong> instead.</p>

<h3 id="class">class</h3>

<p>Remove the property. Use <code class="language-plaintext highlighter-rouge">static</code> variables in your <code class="language-plaintext highlighter-rouge">@implementation</code>
then write and declare <code class="language-plaintext highlighter-rouge">+</code> accessors for them.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> <code class="language-plaintext highlighter-rouge">class</code> is likely to make a comeback in a future version.</div>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: @synthesize is useless now</h1>
             <p>If <code class="language-plaintext highlighter-rouge">@synthesize</code> renames the instance variable, you will unfortunately have to
actually rename the instance variable to the name of the property prefixed
with an underscore, otherwise it won’t work. Do best is to just delete the
<code class="language-plaintext highlighter-rouge">@synthesize</code> and fix the errors.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Synchronized is gone</h1>
             <div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> See <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/ThreadSafety/ThreadSafety.html#//apple_ref/doc/uid/10000057i-CH8-SW16">Threading Programming Guide</a> for more information about <tt>@synchronized</tt>.</div>

<h2 id="use-mulle-thread-for-least-hassle">Use mulle-thread for least hassle.</h2>

<p><a href="//github.com/mulle-concurrent/mulle-thread">mulle-thread</a>
is available on all platforms, that run Objective-C.</p>

<p>Use <code class="language-plaintext highlighter-rouge">mulle_thread_mutex_t</code> to transform</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">myFunction</span>
<span class="p">{</span>
   <span class="k">@synchronized</span><span class="p">()</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>to</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">mulle_thread_mutex_t</span>   <span class="n">lock</span><span class="p">;</span>


<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">load</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">unload</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_done</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">myFunction</span>
<span class="p">{</span>
   <span class="n">mulle_thread_mutex_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
   <span class="p">{</span>

   <span class="p">}</span>
   <span class="n">mulle_thread_mutex_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="use-nslock-instead">Use NSLock instead</h2>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">NSLock</span>   <span class="n">lock</span><span class="p">;</span>


<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">initialize</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">lock</span><span class="p">)</span>
      <span class="n">lock</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSLock</span> <span class="nf">new</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">deinitialize</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">lock</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="p">[</span><span class="n">lock</span> <span class="nf">release</span><span class="p">];</span>
      <span class="n">lock</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">myFunction</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">lock</span> <span class="nf">lock</span><span class="p">];</span>
   <span class="p">{</span>

   <span class="p">}</span>
   <span class="p">[</span><span class="n">lock</span> <span class="nf">unlock</span><span class="p">];</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="good-points">Good points</h3>

<ul>
  <li>code works in all runtimes without another dependency</li>
  <li><code class="language-plaintext highlighter-rouge">+deinitialize</code> will not be called by other runtimes, it’s a harmless addition</li>
</ul>

<h3 id="bad-points">Bad points</h3>

<ul>
  <li>A <strong>NSLock</strong> is slower than a <code class="language-plaintext highlighter-rouge">mulle_thread_mutex_t</code></li>
  <li>The lock has not become a proper mulle-objc root object, so this code will leak in tests.</li>
</ul>

<p>You could fix this with deleting <code class="language-plaintext highlighter-rouge">+deinitialize</code> and rewriting <code class="language-plaintext highlighter-rouge">+initialize</code> as:</p>

<p>``` objc</p>
<ul>
  <li>(void) initialize
{
 if( ! lock)
 {
    lock = [NSLock new];
#ifdef <strong>MULLE_OBJC</strong>
    [lock _becomeRootObject];
    [lock release;]
#endif
 }
}</li>
</ul>

<p>// + (void) deinitialize clashes with  _becomeRootObject and must be removed</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Variable Arguments in Methods</h1>
             <h2 id="intro">Intro</h2>

<p>Variable arguments in methods follow the Mulle MetaABI and are incompatible
with <code class="language-plaintext highlighter-rouge">va_list</code>. C functions continue to use <code class="language-plaintext highlighter-rouge">va_list</code> though. So mulle-objc
will support both formats.</p>

<h3 id="a-typical-variable-argument-method">A typical variable argument method</h3>

<h4 id="va_list">va_list</h4>

<p>This is the <code class="language-plaintext highlighter-rouge">+[NSString stringWithFormat:]</code> method as presumably coded in the
Apple Foundation. Conventionally the <code class="language-plaintext highlighter-rouge">va_list</code> parameter in Apple Foundation
methods is called “arguments:”:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">stringWithFormat</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span><span class="p">,</span> <span class="p">...</span>
<span class="p">{</span>
   <span class="n">NSString</span>   <span class="o">*</span><span class="n">s</span><span class="p">;</span>
   <span class="kt">va_list</span>    <span class="n">args</span><span class="p">;</span>

   <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
   <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="n">format</span>
              <span class="nl">arguments:</span><span class="n">args</span><span class="p">];</span>
   <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="mulle_vararg_list">mulle_vararg_list</h4>

<p>In mulle-objc the type is <code class="language-plaintext highlighter-rouge">mulle_vararg_list</code>. And if it is used as a
parameter its called “mulleVarargList:” by convention. <code class="language-plaintext highlighter-rouge">va_list</code> which is still
a possibility type due to C code (e.g. <code class="language-plaintext highlighter-rouge">NSLog</code>), is called  <code class="language-plaintext highlighter-rouge">varargList:</code>
instead for discrimination.</p>

<p>This is how <code class="language-plaintext highlighter-rouge">+[NSString stringWithFormat:]</code> is actually coded in
MulleFoundation:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">stringWithFormat</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span><span class="p">,</span> <span class="p">...</span>
<span class="p">{</span>
   <span class="n">NSString</span>             <span class="o">*</span><span class="n">s</span><span class="p">;</span>
   <span class="n">mulle_vararg_list</span>    <span class="n">args</span><span class="p">;</span>

   <span class="n">mulle_vararg_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
   <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="n">format</span>
              <span class="nl">mulleVarargList:</span><span class="n">args</span><span class="p">];</span>
   <span class="n">mulle_vararg_end</span><span class="p">(</span> <span class="n">args</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So that’s pretty similar.</p>

<h4 id="mulle-objc-supports-both">mulle-objc supports both</h4>

<p>It’s not an either or scenarion, as mulle-objc supports both:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">stringWithFormat</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span>
                  <span class="n">mulleVarargList</span><span class="o">:</span><span class="p">(</span><span class="n">mulle_vararg_list</span><span class="p">)</span> <span class="n">arguments</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[[[</span><span class="n">self</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFormat</span><span class="p">:</span><span class="n">format</span>
                         <span class="nl">mulleVarargList:</span><span class="n">arguments</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">stringWithFormat</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span>
                       <span class="n">varargList</span><span class="o">:</span><span class="p">(</span><span class="kt">va_list</span><span class="p">)</span> <span class="n">args</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="p">[[[</span><span class="n">self</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFormat</span><span class="p">:</span><span class="n">format</span>
                                 <span class="nl">varargList:</span><span class="n">args</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="accessing-variable-arguments">Accessing variable arguments</h2>

<p>The actual access of variable arguments of <code class="language-plaintext highlighter-rouge">mulle_vararg_list</code> is very
different though.</p>

<p>See <a href="https://github.com/MulleFoundation/objc-compat">objc-compat</a> for some
details on how to achieve this portably.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: NSZone</h1>
             <p>Zones are dead. Do not use the <code class="language-plaintext highlighter-rouge">withZone:</code> methods anymore.</p>

<p>mulle-objc will work well enough if you use them, but they are just superflous.
Incidentally I don’t think Apple Objective-C uses zones either anymore.</p>

<h3 id="compiler-transforms--zone-calls">Compiler transforms -zone calls</h3>

<p>With that being said, the <strong>mulle-clang</strong> compiler will transform any
call to <code class="language-plaintext highlighter-rouge">-zone</code> into <code class="language-plaintext highlighter-rouge">NULL</code>.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: unichar</h1>
             <p>Apple Foundation uses UTF-16 as <code class="language-plaintext highlighter-rouge">unichar</code>, whereas the mulle-objc Foundation used
UTF-32 as <code class="language-plaintext highlighter-rouge">unichar</code>. As long as your code is not assuming 16-bit for its size,
there should be no problem.</p>

<p>When accessing string contents as <code class="language-plaintext highlighter-rouge">unichar *</code> with <code class="language-plaintext highlighter-rouge">dataUsingEncoding:</code> use the
generic <code class="language-plaintext highlighter-rouge">NSUnicodeStringEncoding</code> instead of <code class="language-plaintext highlighter-rouge">NSUTF32StringEncoding</code>/<code class="language-plaintext highlighter-rouge">NSUTF16StringEncoding</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  data = [s dataUsingEncoding:NSUnicodeStringEncoding];
  here_some_unichars( (unichar *) [data bytes], [data length] / sizeof( unichar));
</code></pre></div></div>

<p>TODO:  How about <code class="language-plaintext highlighter-rouge">printf</code> with <code class="language-plaintext highlighter-rouge">%S</code> ?</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Objective-C++</h1>
             <div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> C++ is already the most complex language in the
world and adding Objective-C on top of it, is like the worst of both worlds.</div>

<h2 id="use-c-from-objective-c">Use C++ from Objective-C</h2>

<p>Create a C code wrapper to call the C++ functions. Then call the C code from
Objective-C.</p>

<p>C++</p>

<p><code class="language-plaintext highlighter-rouge">cpp.h:</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
<span class="cp">#endif
</span>   <span class="kt">void</span>  <span class="n">call_cpp1</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
   <span class="kt">char</span>  <span class="o">*</span><span class="n">call_cpp2</span><span class="p">(</span> <span class="kt">void</span><span class="p">);</span>
<span class="cp">#ifdef __cplusplus
</span><span class="p">};</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>Objective-C</p>

<p><code class="language-plaintext highlighter-rouge">foo.m</code></p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;cpp.h&gt;</span><span class="cp">
</span>
<span class="k">@implementation</span> <span class="nc">Foo</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">callCPlusPlus1</span><span class="p">:(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span>
<span class="p">{</span>
   <span class="n">call_cpp1</span><span class="p">(</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">callCPlusPlus2</span>
<span class="p">{</span>
   <span class="k">return</span><span class="p">(</span> <span class="n">call_cpp2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<h2 id="use-objective-c-from-c">Use Objective-C from C++</h2>

<p>This is possible too, but you need to link against the <code class="language-plaintext highlighter-rouge">mulle-objc-runtime.h</code>
only:</p>

<blockquote>
  <p>TODO: test this does this work with mulle-c11 ?</p>
</blockquote>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&lt;mulle-objc/mulle-objc-runtime.h&gt;</span><span class="cp">
</span><span class="p">};</span>
<span class="cp">#endif
</span></code></pre></div></div>

<p>Now you can use the runtime functions to create instances and call them.
It’s very cumbersome though.</p>


             
             <div class="pagebreak"></div>
             
         
             <h1>Porting: Xcode projects</h1>
             <p>As <strong>mulle-objc</strong> evolves, more and more Xcode projects will be portable
without effort. For now Foundation based Tool and Library targets are
the candidates for porting.</p>

<h2 id="mulle-xcode-to-cmake">mulle-xcode-to-cmake</h2>

<p>Getting an existing Xcode project to run with <strong>mulle-objc</strong> can be very easy
with <a href="//github.com/mulle-nat/mulle-xcode-to-cmake">mulle-xcode-to-cmake</a>.
Assuming  that your Xcode project file is named “project.xcodeproj”, these
steps may already be sufficient:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mulle-xcode-to-cmake <span class="nb">export </span>project.xcodeproj <span class="o">&gt;</span> CMakeLists.txt
mulle-sde init <span class="nt">-m</span> foundation/objc-porter executable
mulle-sde craft
</code></pre></div></div>

<p>To install:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mulle-sde craft craftorder
mulle-sde run mulle-make <span class="nb">install</span> <span class="nt">--prefix</span> /tmp/whereever
</code></pre></div></div>

<h2 id="converting-to-the-modern-workflow">Converting to the modern workflow</h2>

<p>If your project contains one or many libraries, it is best to split them
up into multiple projects.</p>

<p>Replace the <em>objc-porter</em> environment with the <em>objc-developer</em> environment:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> .mulle
mulle-sde init <span class="nt">-m</span> foundation/objc-developer executable
</code></pre></div></div>

<p>And then you are ready to setup a <a href="modern.html">project</a>.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Tooling: mulle-objc Tools</h1>
             <h2 id="mulle-objc-listmulle-objc-lista">mulle-objc-list/mulle-objc-lista</h2>

<p><strong>mulle-objc-list</strong> generates CSV style information from dynamic libraries,
that contain mulle-objc code. You can list the contained classes, methods and
properties. It’s the backbone of the mulle-objc tool set.</p>

<p><strong>mulle-objc-lista</strong> is the variant that handles static libraries.</p>

<p>See <a href="//github.com/mulle-objc/mulle-objc-runtime">mulle-objc-runtime</a> for more
details.</p>

<h2 id="mulle-objc-uniqueid">mulle-objc-uniqueid</h2>

<p>Generates the <code class="language-plaintext highlighter-rouge">@selector()</code> hash value from a string. This can be useful when
writing C code, that calls Objective-C.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>mulle-objc-uniqueid alloc
<span class="go">ab1bb16b
</span></code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mulle_objc_object_call</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="mh">0xab1bb16b</span><span class="p">,</span> <span class="n">nil</span><span class="p">);</span>
</code></pre></div></div>

<p>See <a href="//github.com/mulle-objc/mulle-objc-runtime">mulle-objc-runtime</a> for more
details.</p>

<h2 id="mulle-objc-loader-tool">mulle-objc-loader-tool</h2>

<p>Generates the required <code class="language-plaintext highlighter-rouge">MulleObjCLoader</code> category files for a library.
This tool is used in the <a href="modern">modern workflow</a> to generate the
proper dependency information.</p>

<p>See <a href="//github.com/mulle-objc/mulle-objc-list">mulle-objc-list</a> for more
details.</p>

<h2 id="mulle-objc-signature">mulle-objc-signature</h2>

<p>Separates an ‘@encode()’ Objective-C type into constituents, separated by ‘;’.
This can be useful for creating inspection tools.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>mulle-objc-uniqueid alloc ^v@:@<span class="s2">"NSString"</span>
<span class="gp">^v;</span>@<span class="p">;</span>:<span class="p">;</span>@<span class="s2">"NSString"</span>
</code></pre></div></div>
<p>See <a href="//github.com/mulle-objc/mulle-objc-runtime">mulle-objc-runtime</a> for more
details.</p>

<h2 id="mulle-objc-printline">mulle-objc-printline</h2>

<p>A little utility to fake a “class-coverage.csv” entry.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>mulle-objc-printline <span class="nt">--method</span> <span class="nt">-foo</span> <span class="nt">--category</span> Foo Bar
<span class="gp">bbc7dbad;</span>Bar<span class="p">;</span>c7e16770<span class="p">;</span>Foo<span class="p">;</span>9f37ed7a<span class="p">;</span><span class="nt">-foo</span>
</code></pre></div></div>
<p>See <a href="coverage.html">Coverage</a> for more details about mulle-objc
coverage information.</p>

<h2 id="mulle-objc-searchid">mulle-objc-searchid</h2>

<p>Grep through libraries to find the matching string for a selector, classid,
protocol et.c.  This can be useful when debugging optimized code.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>mulle-objc-searchid ab1bb16b
<span class="go">@selector( alloc) is ab1bb16b
</span></code></pre></div></div>

<p>See <a href="//github.com/mulle-objc/mulle-objc-list">mulle-objc-list</a> for more
details.</p>

<h2 id="mulle-objc-unarchive">mulle-objc-unarchive</h2>

<p>Used by the library optimization process, that unpacks and repacks static
libraries to only contain required classes and categories.</p>

<p>See <a href="//github.com/mulle-objc/mulle-objc-list">mulle-objc-list</a> for more
details.</p>

<h2 id="mulle-objc-uncovered-methods">mulle-objc-uncovered-methods</h2>

<p>Creates a list of methods not being messaged during a programs run. This can
be useful for finding missing tests.</p>

<p>See <a href="coverage.html">Coverage</a> for more details about mulle-objc coverage information.</p>

             
             <div class="pagebreak"></div>
             
         
             <h1>Tooling: Coverage information</h1>
             <h2 id="coverage">Coverage</h2>

<p>You can create Objective-C coverage information for any mulle-objc program.</p>

<p>Coverage files will be are generated when you run the program with
with the environment variables <code class="language-plaintext highlighter-rouge">MULLE_OBJC_PEDANTIC_EXIT</code> and
<code class="language-plaintext highlighter-rouge">MULLE_OBJC_COVERAGE</code> set to YES:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MULLE_OBJC_PEDANTIC_EXIT</span><span class="o">=</span>YES <span class="nv">MULLE_OBJC_COVERAGE</span><span class="o">=</span>YES myexe
</code></pre></div></div>

<p>This will produce two coverage files <code class="language-plaintext highlighter-rouge">class-coverage.csv</code> and
<code class="language-plaintext highlighter-rouge">method-coverage.csv</code>.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Your executable needs to properly terminate, to generate
coverage information. If that isn’t possible, call
<code class="language-plaintext highlighter-rouge">mulle_objc_csvdump_methodcoverage()</code> and <code class="language-plaintext highlighter-rouge">mulle_objc_csvdump_classcoverage()</code>
yourself, when you know the runtime system is quiescent.</div>

<h2 id="extending-coverage-files">Extending coverage files</h2>

<p>A second “coverage” run will append to previously existing coverage files.
But you can also concatenate coverage files from various source with <code class="language-plaintext highlighter-rouge">cat</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>coverage<span class="k">*</span>.txt | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> class-coverage.csv
</code></pre></div></div>

             
             <div class="pagebreak"></div>
             
         
             <h1>Tooling: Code reduction</h1>
             <h2 id="reduction">Reduction</h2>

<p>With the coverage information gained in the previous chapter, we can now
extract the required <code class="language-plaintext highlighter-rouge">.o</code> files from the static libraries and create a
custom static library, that contains only the necessary files.</p>

<h2 id="todo">TODO</h2>

<p>Explain how this is done with the cmake <code class="language-plaintext highlighter-rouge">OBJC_COVERAGE_OPTIMIZED_LIBS</code>.</p>

<blockquote>
  <p>I have this already written somewhere…</p>
</blockquote>


             
         
         </div>
         <hr>
         <div class="bio">
               

               <div class="bio-photo-container" style="display: inline-block">
                     
                     <img src="images/dog-pic.jpg" class="bio-photo" alt="Nat! bio photo">
                     
               </div>
               <div style="display: inline-block; padding-left: 8px">
                     <h4>Nat!</h4>
                     <p>Senior Mull</p>
               </div>

               <div class="author-social"><a href="//www.mulle-kybernetik.com" target="_blank" class="link"><img class="inline-img" src="images/homepage-svgrepo-com.svg"></a>&nbsp;&nbsp;<a href="//www.mulle-kybernetik.com" target="_blank" class="link">WWW</a></div>

               <div class="author-social"><a href="mailto:nat-objects@emulle-kybernetik.com" target="_blank"><img class="inline-img" src="images/email-svgrepo-com.svg"></a>&nbsp;&nbsp;<a href="mailto:nat-objects@emulle-kybernetik.com" target="_blank" class="link">Email</a></div>
               <div class="author-social"><a href="//twitter.com/mulle_nat" target="_blank"><img class="inline-img" src="images/twitter-svgrepo-com.svg"></a>&nbsp;&nbsp;<a href="//twitter.com/mulle_nat" target="_blank" class="link">Twitter</a></div>

               <div class="author-social"><a href="//github.com/mulle-nat" target="_blank"><img class="inline-img" src="images/github-svgrepo-com.svg"></a>&nbsp;&nbsp;<a href="//github.com/mulle-nat" target="_blank" class="link">Github</a></div>
               <div class="author-social"><a href="//twitch.tv/Mulle_kybernetiK_TV" target="_blank"><img class="inline-img" src="images/twitch-svgrepo-com.svg"></a>&nbsp;&nbsp;<a href="//twitch.tv/Mulle_kybernetiK_TV" target="_blank" class="link">Twitch</a></div>
</div> <!-- bio -->

      </div>
   </div>
</div>
    <script>
document.querySelectorAll('pre').forEach((block) => {
    const button = document.createElement('button');
    button.className = 'copy-button';
    button.innerHTML = `<svg aria-hidden="true" data-prefix="far" data-icon="copy" class="svg-inline--fa fa-copy fa-fw fa-1x" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 440 500"><path fill="currentColor" d="M384 336H192c-9 0-16-7-16-16V64c0-9 7-16 16-16h140l68 68v204c0 9-7 16-16 16zm-192 48h192c35 0 64-29 64-64V116c0-13-5-25-14-34l-68-68c-9-9-21-14-34-14H192c-35 0-64 29-64 64v256c0 35 29 64 64 64zM64 128c-35 0-64 29-64 64v256c0 35 29 64 64 64h192c35 0 64-29 64-64v-32h-48v32c0 9-7 16-16 16H64c-9 0-16-7-16-16V192c0-9 7-16 16-16h32v-48H64z"/></svg>`;

    block.appendChild(button);

    button.addEventListener('click', () => {
        const code = block.querySelector('code');
        navigator.clipboard.writeText(code.textContent).then(() => {
            // Change icon to checkmark
            const originalHTML = button.innerHTML;
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M20 5a1 1 0 0 1 0 1l-9 13a1 1 0 0 1-1 0l-7-6a1 1 0 0 1 1-1l5 6 10-13a1 1 0 0 1 1 0z" clip-rule="evenodd"/></svg>';

            // Reset after delay
            setTimeout(() => {
                // Restore original icon
                button.innerHTML = originalHTML;
                // fidget this for reasons...
                button.style.color = '#6a6a7c';
            }, 500);
        });
    });
});

    </script>

<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setCookieDomain", "*.www.mulle-kybernetik.com"]);
  _paq.push(["setDomains", ["*.www.mulle-kybernetik.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//www.mulle-kybernetik.com/matomo/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//www.mulle-kybernetik.com/matomo/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
<!-- End Matomo Code -->

</body>
</html>
